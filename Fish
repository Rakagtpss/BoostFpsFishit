-- [1] Notifikasi Awal (Safe Load)
pcall(function()
    game:GetService("StarterGui"):SetCore("SendNotification", {
        Title = "Seraphin Helper",
        Text = "SCRIPT LOADING",
        Duration = 2,
    })
end)

task.wait(3.5)

-- [2] Variable & Services (Cached for Performance)
local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    Lighting = game:GetService("Lighting"),
    TeleportService = game:GetService("TeleportService"),
    UserInputService = game:GetService("UserInputService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    TweenService = game:GetService("TweenService"),
    Workspace = game:GetService("Workspace")
}

local Player = Services.Players.LocalPlayer
local Char = Player.Character or Player.CharacterAdded:Wait()
local HRP = Char:WaitForChild("HumanoidRootPart", 10)
local Hum = Char:WaitForChild("Humanoid", 10)

-- Auto Update Character saat Respawn (Optimized Connection)
Player.CharacterAdded:Connect(function(newChar)
    Char = newChar
    HRP = newChar:WaitForChild("HumanoidRootPart", 10)
    Hum = newChar:WaitForChild("Humanoid", 10)
end)

-- // Konfigurasi Visual (TEMA CYAN & LIGHTWEIGHT)
local UI_THEME = {
    MinWidth = 260,  
    MinHeight = 240,
    Color = Color3.fromRGB(10, 10, 10), 
    Transparency = 0.25, 
    HeaderColor = Color3.fromRGB(5, 5, 5),
    Accent = Color3.fromRGB(0, 255, 255),
    TabOff = Color3.fromRGB(120, 120, 120),
    TabOn = Color3.fromRGB(255, 255, 255),
    TextColor = Color3.fromRGB(255, 255, 255),
    SubTextColor = Color3.fromRGB(180, 180, 180),
    Font = Enum.Font.GothamBold,
    BtnFont = Enum.Font.GothamMedium 
}

-- Bersihkan UI Lama
if Services.CoreGui:FindFirstChild("SeraphinHelper") then Services.CoreGui.SeraphinHelper:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SeraphinHelper"
ScreenGui.Parent = Services.CoreGui
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- ====================================================
-- [1] MINI FLOATING HUD (Optimized)
-- ====================================================
local FloatHUD = Instance.new("Frame", ScreenGui)
FloatHUD.Name = "FloatingStats"
FloatHUD.Size = UDim2.new(0, 140, 0, 125) 
FloatHUD.Position = UDim2.new(0.85, 0, 0.4, 0)
FloatHUD.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
FloatHUD.BackgroundTransparency = 0.4
FloatHUD.Visible = true
FloatHUD.Active = true -- Penting untuk drag script custom

local HudStroke = Instance.new("UIStroke", FloatHUD)
HudStroke.Color = UI_THEME.Accent
HudStroke.Thickness = 1.5
HudStroke.Transparency = 0

Instance.new("UICorner", FloatHUD).CornerRadius = UDim.new(0, 8)

local ListLayout = Instance.new("UIListLayout", FloatHUD)
ListLayout.FillDirection = Enum.FillDirection.Vertical
ListLayout.Padding = UDim.new(0, 6) 
ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
ListLayout.VerticalAlignment = Enum.VerticalAlignment.Top
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder 

local Padding = Instance.new("UIPadding", FloatHUD)
Padding.PaddingTop = UDim.new(0, 10) 
Padding.PaddingBottom = UDim.new(0, 8)
Padding.PaddingLeft = UDim.new(0, 5)
Padding.PaddingRight = UDim.new(0, 5)

-- JUDUL PANEL HUD
local TitleLabel = Instance.new("TextLabel", FloatHUD)
TitleLabel.LayoutOrder = 1
TitleLabel.Size = UDim2.new(1, 0, 0, 15)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "PANEL SERAPHIN"
TitleLabel.TextColor3 = UI_THEME.Accent 
TitleLabel.Font = Enum.Font.GothamBlack
TitleLabel.TextSize = 14
TitleLabel.TextStrokeTransparency = 0.8

local Div = Instance.new("Frame", FloatHUD)
Div.LayoutOrder = 2
Div.Size = UDim2.new(0.8, 0, 0, 1)
Div.BackgroundColor3 = UI_THEME.Accent
Div.BorderSizePixel = 0

local function CreateStatBlock(titleText, defaultVal, order)
    local Block = Instance.new("Frame", FloatHUD)
    Block.Name = titleText.."Block"
    Block.LayoutOrder = order
    Block.Size = UDim2.new(1, 0, 0, 35) 
    Block.BackgroundTransparency = 1
    
    local LblTitle = Instance.new("TextLabel", Block)
    LblTitle.Name = "Title"
    LblTitle.Size = UDim2.new(1, 0, 0, 12)
    LblTitle.Position = UDim2.new(0, 0, 0, 0)
    LblTitle.BackgroundTransparency = 1
    LblTitle.Text = string.upper(titleText)
    LblTitle.TextColor3 = UI_THEME.SubTextColor
    LblTitle.Font = Enum.Font.GothamBold
    LblTitle.TextSize = 9
    
    local LblValue = Instance.new("TextLabel", Block)
    LblValue.Name = "Value"
    LblValue.Size = UDim2.new(1, 0, 0, 20)
    LblValue.Position = UDim2.new(0, 0, 0, 14)
    LblValue.BackgroundTransparency = 1
    LblValue.Text = defaultVal
    LblValue.TextColor3 = UI_THEME.TextColor
    LblValue.Font = Enum.Font.GothamBold
    LblValue.TextSize = 16 
    return LblValue 
end

local LblFishVal = CreateStatBlock("FISH CAUGHT", "Loading...", 3) 
local LblInvVal  = CreateStatBlock("BACKPACK", "0 / 0", 4)     

-- ====================================================
-- [2] MAIN MENU UI
-- ====================================================
local Main = Instance.new("Frame", ScreenGui)
Main.Name = "Main"
Main.Size = UDim2.new(0, UI_THEME.MinWidth, 0, UI_THEME.MinHeight)
Main.Position = UDim2.new(0.5, -UI_THEME.MinWidth/2, 0.4, 0)
Main.BackgroundColor3 = UI_THEME.Color
Main.BackgroundTransparency = UI_THEME.Transparency
Main.Active = true
Main.ClipsDescendants = true 

Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 8)

local MainStroke = Instance.new("UIStroke", Main)
MainStroke.Color = UI_THEME.Accent
MainStroke.Thickness = 1.5
MainStroke.Transparency = 0

-- HEADER
local Header = Instance.new("Frame", Main)
Header.Name = "Header"
Header.Size = UDim2.new(1, 0, 0, 32) 
Header.BackgroundColor3 = UI_THEME.HeaderColor
Header.BackgroundTransparency = 0.5
Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 8)

-- [OPTIMIZED DRAG SCRIPT]
local function EnableDrag(frame, dragInputObj)
    local dragToggle, dragStart, startPos
    local function updateInput(input)
        local delta = input.Position - dragStart
        local position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        frame.Position = position
    end
    dragInputObj.InputBegan:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
            dragToggle = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragToggle = false
                end
            end)
        end
    end)
    dragInputObj.InputChanged:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local dragInput = input
            Services.UserInputService.InputChanged:Connect(function(inputCheck)
                if inputCheck == dragInput and dragToggle then
                    updateInput(inputCheck)
                end
            end)
        end
    end)
end
EnableDrag(Main, Header)
EnableDrag(FloatHUD, FloatHUD) -- FloatHUD juga bisa digeser sekarang

-- TITLE
local Title = Instance.new("TextLabel", Header)
Title.Size = UDim2.new(1, -60, 1, 0) 
Title.Position = UDim2.new(0, 0, 0, 0) 
Title.Text = "SERAPHIN <font color=\"rgb(0,255,255)\">HELPER</font>" 
Title.RichText = true
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = UI_THEME.Font
Title.TextSize = 11
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Center 

-- HIDE BUTTON
local HideBtn = Instance.new("TextButton", Header)
HideBtn.Size = UDim2.new(0, 45, 0, 20) 
HideBtn.Position = UDim2.new(1, -50, 0.5, -10)
HideBtn.Text = "Hide" 
HideBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
HideBtn.BackgroundTransparency = 0.5
HideBtn.TextColor3 = UI_THEME.Accent
HideBtn.Font = Enum.Font.GothamBold
HideBtn.TextSize = 10
HideBtn.AutoButtonColor = true
Instance.new("UICorner", HideBtn).CornerRadius = UDim.new(0, 4)
local HideStroke = Instance.new("UIStroke", HideBtn)
HideStroke.Color = UI_THEME.Accent
HideStroke.Transparency = 0.6

-- ====================================================
-- [3] TAB SYSTEM
-- ====================================================
local TabHolder = Instance.new("Frame", Main)
TabHolder.Name = "TabHolder"
TabHolder.Size = UDim2.new(1, 0, 0, 25)
TabHolder.Position = UDim2.new(0, 0, 0, 32)
TabHolder.BackgroundTransparency = 1

local TabMainBtn = Instance.new("TextButton", TabHolder)
TabMainBtn.Name = "MainTab"
TabMainBtn.Size = UDim2.new(0.5, 0, 1, 0)
TabMainBtn.BackgroundTransparency = 1
TabMainBtn.Text = "MAIN"
TabMainBtn.Font = Enum.Font.GothamBold
TabMainBtn.TextSize = 11
TabMainBtn.TextColor3 = UI_THEME.TabOn

local TabMiscBtn = Instance.new("TextButton", TabHolder)
TabMiscBtn.Name = "MiscTab"
TabMiscBtn.Size = UDim2.new(0.5, 0, 1, 0)
TabMiscBtn.Position = UDim2.new(0.5, 0, 0, 0)
TabMiscBtn.BackgroundTransparency = 1
TabMiscBtn.Text = "MISC"
TabMiscBtn.Font = Enum.Font.GothamBold
TabMiscBtn.TextSize = 11
TabMiscBtn.TextColor3 = UI_THEME.TabOff

local TabIndicator = Instance.new("Frame", TabHolder)
TabIndicator.Size = UDim2.new(0.5, 0, 0, 2)
TabIndicator.Position = UDim2.new(0, 0, 1, -2)
TabIndicator.BackgroundColor3 = UI_THEME.Accent
TabIndicator.BorderSizePixel = 0

-- PAGES CONTAINER
local PageContainer = Instance.new("Frame", Main)
PageContainer.Name = "PageContainer"
PageContainer.Size = UDim2.new(1, -16, 1, -65) 
PageContainer.Position = UDim2.new(0, 8, 0, 60)
PageContainer.BackgroundTransparency = 1

local PageMain = Instance.new("Frame", PageContainer)
PageMain.Name = "PageMain"
PageMain.Size = UDim2.new(1, 0, 1, 0)
PageMain.BackgroundTransparency = 1
PageMain.Visible = true

local GridMain = Instance.new("UIGridLayout", PageMain)
GridMain.CellSize = UDim2.new(0, 128, 0, 28) 
GridMain.CellPadding = UDim2.new(0, 8, 0, 12) 
GridMain.HorizontalAlignment = Enum.HorizontalAlignment.Center

local PageMisc = Instance.new("Frame", PageContainer)
PageMisc.Name = "PageMisc"
PageMisc.Size = UDim2.new(1, 0, 1, 0)
PageMisc.BackgroundTransparency = 1
PageMisc.Visible = false

local GridMisc = Instance.new("UIGridLayout", PageMisc)
GridMisc.CellSize = UDim2.new(0, 128, 0, 28) 
GridMisc.CellPadding = UDim2.new(0, 8, 0, 12) 
GridMisc.HorizontalAlignment = Enum.HorizontalAlignment.Center

local function SwitchTab(tabName)
    if tabName == "Main" then
        PageMain.Visible = true
        PageMisc.Visible = false
        TabMainBtn.TextColor3 = UI_THEME.TabOn
        TabMiscBtn.TextColor3 = UI_THEME.TabOff
        TabIndicator:TweenPosition(UDim2.new(0, 0, 1, -2), "Out", "Quad", 0.2)
    elseif tabName == "Misc" then
        PageMain.Visible = false
        PageMisc.Visible = true
        TabMainBtn.TextColor3 = UI_THEME.TabOff
        TabMiscBtn.TextColor3 = UI_THEME.TabOn
        TabIndicator:TweenPosition(UDim2.new(0.5, 0, 1, -2), "Out", "Quad", 0.2)
    end
end

TabMainBtn.MouseButton1Click:Connect(function() SwitchTab("Main") end)
TabMiscBtn.MouseButton1Click:Connect(function() SwitchTab("Misc") end)

-- ====================================================
-- [4] LOGIC UI & HELPER FUNCTIONS
-- ====================================================
local IsMinimized = false

HideBtn.MouseButton1Click:Connect(function() 
    IsMinimized = not IsMinimized 
    if IsMinimized then
        PageContainer.Visible = false
        TabHolder.Visible = false
        Main:TweenSize(UDim2.new(0, UI_THEME.MinWidth, 0, 32), "Out", "Quad", 0.3, true) 
        HideBtn.Text = "Show" 
        HideBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
    else
        Main:TweenSize(UDim2.new(0, UI_THEME.MinWidth, 0, UI_THEME.MinHeight), "Out", "Back", 0.3, true) 
        HideBtn.Text = "Hide" 
        HideBtn.TextColor3 = UI_THEME.Accent
        task.delay(0.2, function() 
            if not IsMinimized then 
                PageContainer.Visible = true 
                TabHolder.Visible = true
            end 
        end)
    end
end)

local function MakeBtn(parent, text)
    local b = Instance.new("TextButton", parent)
    b.Text = text
    b.BackgroundColor3 = Color3.fromRGB(0, 0, 0) 
    b.BackgroundTransparency = 0.5
    b.TextColor3 = UI_THEME.TextColor
    b.Font = UI_THEME.BtnFont 
    b.TextSize = 10 
    b.AutoButtonColor = true
    b.ClipsDescendants = true
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 4) 
    local s = Instance.new("UIStroke", b)
    s.Color = UI_THEME.Accent 
    s.Thickness = 1
    s.Transparency = 0.6
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    return b
end

local function ToggleVisual(btn, on)
    if on then
        btn.BackgroundColor3 = UI_THEME.Accent 
        btn.BackgroundTransparency = 0.2
        btn.TextColor3 = Color3.fromRGB(0, 0, 0) 
        btn.UIStroke.Transparency = 1
        btn.Font = Enum.Font.GothamBold
    else
        btn.BackgroundColor3 = Color3.fromRGB(0, 0, 0) 
        btn.BackgroundTransparency = 0.5
        btn.TextColor3 = UI_THEME.TextColor
        btn.UIStroke.Transparency = 0.6
        btn.Font = UI_THEME.BtnFont
    end
end

local function Notify(title, text)
    Services.StarterGui:SetCore("SendNotification", { Title = title, Text = text, Duration = 3 })
end

-- States
local States = {
    Freeze=false, WoW=false, Boost=false, NoRender=false, 
    Noclip=false, Panel=true, AutoEquip=false,
    AutoEvent=false, AntiStuck=false, StuckTimeout=60 
}
local SavedCFrame = nil 
local EventStartCFrame = nil 
local IsInEvent = false 
local Connections = {}
local BodyV = nil
local LastFishCaughtTime = tick()
local LastFishCount = 0

-- >> TOMBOL UI <<

-- TAB MAIN
local BtnEvent  = MakeBtn(PageMain, "Auto Event: OFF") 
local BtnEquip  = MakeBtn(PageMain, "Auto Equip: OFF")
local BtnWow    = MakeBtn(PageMain, "Water Walk: OFF")
local BtnFreeze = MakeBtn(PageMain, "Freeze: OFF")
local BtnNoclip = MakeBtn(PageMain, "No Clip: OFF")
local BtnBoost  = MakeBtn(PageMain, "CPU Booster: OFF") 
local BtnRender = MakeBtn(PageMain, "3D Render: ON") 
local BtnFps    = MakeBtn(PageMain, "FPS: Max") 

-- TAB MISC
local StuckContainer = Instance.new("Frame", PageMisc)
StuckContainer.Name = "StuckContainer"
StuckContainer.BackgroundTransparency = 1

local BtnStuckToggle = Instance.new("TextButton", StuckContainer)
BtnStuckToggle.Name = "Toggle"
BtnStuckToggle.Size = UDim2.new(0.65, -4, 1, 0)
BtnStuckToggle.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BtnStuckToggle.BackgroundTransparency = 0.5
BtnStuckToggle.Text = "Anti-Stuck: OFF"
BtnStuckToggle.TextColor3 = UI_THEME.TextColor
BtnStuckToggle.Font = UI_THEME.BtnFont
BtnStuckToggle.TextSize = 10
Instance.new("UICorner", BtnStuckToggle).CornerRadius = UDim.new(0, 4)
local s1 = Instance.new("UIStroke", BtnStuckToggle)
s1.Color = UI_THEME.Accent
s1.Thickness = 1
s1.Transparency = 0.6

local BoxStuckInput = Instance.new("TextBox", StuckContainer)
BoxStuckInput.Name = "Input"
BoxStuckInput.Size = UDim2.new(0.35, 0, 1, 0)
BoxStuckInput.Position = UDim2.new(0.65, 0, 0, 0)
BoxStuckInput.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BoxStuckInput.BackgroundTransparency = 0.5
BoxStuckInput.Text = "60" -- Default
BoxStuckInput.PlaceholderText = "Sec"
BoxStuckInput.TextColor3 = UI_THEME.Accent
BoxStuckInput.Font = Enum.Font.GothamBold
BoxStuckInput.TextSize = 10
Instance.new("UICorner", BoxStuckInput).CornerRadius = UDim.new(0, 4)
local s2 = Instance.new("UIStroke", BoxStuckInput)
s2.Color = UI_THEME.Accent
s2.Thickness = 1
s2.Transparency = 0.6

local BtnSave   = MakeBtn(PageMisc, "Save Pos")
local BtnLoad   = MakeBtn(PageMisc, "Load Pos")
local BtnRejoin = MakeBtn(PageMisc, "Rejoin Server")
local BtnPanel  = MakeBtn(PageMisc, "Panel Info: ON")

-- [FUNCTION] Logic Water Walk
local function SetWoW(bool)
    States.WoW = bool
    if typeof(BtnWow) == "Instance" then
        BtnWow.Text = "Water Walk: " .. (States.WoW and "ON" or "OFF")
        ToggleVisual(BtnWow, States.WoW)
    end
    
    if States.WoW then 
        if not HRP or not HRP.Parent then return end 
        
        if not BodyV then 
            BodyV = Instance.new("BodyVelocity")
            BodyV.Name = "WoW_Velocity"
            BodyV.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            BodyV.Velocity = Vector3.zero
        end
        BodyV.Parent = HRP
        
        if Connections["WoW"] then Connections["WoW"]:Disconnect() end 
        
        Connections["WoW"] = Services.RunService.RenderStepped:Connect(function() 
            if HRP and Hum and BodyV and BodyV.Parent then
                local moveDir = Hum.MoveDirection
                -- Optimization: Only apply velocity if moving
                if moveDir.Magnitude > 0 then
                    local speed = Hum.WalkSpeed
                    BodyV.Velocity = Vector3.new(moveDir.X * speed, 0, moveDir.Z * speed)
                else
                    BodyV.Velocity = Vector3.zero
                end
            end 
        end) 
    else 
        if Connections["WoW"] then Connections["WoW"]:Disconnect() end 
        if BodyV then BodyV:Destroy(); BodyV = nil end 
    end 
end

local function SetAutoEquip(bool)
    States.AutoEquip = bool
    if typeof(BtnEquip) == "Instance" then
        BtnEquip.Text = "Auto Equip: " .. (States.AutoEquip and "ON" or "OFF")
        ToggleVisual(BtnEquip, States.AutoEquip)
    end
end

local function ForceEquipRod()
    pcall(function()
        local args = { [1] = 1 }
        local pkgs = Services.ReplicatedStorage:FindFirstChild("Packages")
        if pkgs then
            local idx = pkgs:FindFirstChild("_Index")
            if idx then
                local remote = idx:FindFirstChild("sleitnick_net@0.2.0")
                if remote then
                    remote.net:FindFirstChild("RE/EquipToolFromHotbar"):FireServer(unpack(args))
                end
            end
        end
    end)
end

-- ====================================================
-- [FUNCTION] DEEP OPTIMIZATION BOOSTER
-- ====================================================
local function CleanVisuals(parent)
    -- Helper untuk menghapus efek visual saja tanpa merusak script game
    for _, v in pairs(parent:GetDescendants()) do
        if v:IsA("Texture") or v:IsA("Decal") or v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Beam") then
            v:Destroy()
        elseif v:IsA("BasePart") or v:IsA("MeshPart") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
            if v:IsA("MeshPart") then
                v.RenderFidelity = Enum.RenderFidelity.Performance
            end
        end
    end
end

local function OptimizePerformance()
    local startMem = gcinfo()
    
    -- 1. Optimized Internal Settings
    Services.Lighting.GlobalShadows = false
    Services.Lighting.FogEnd = 9e9
    Services.Lighting.Brightness = 1
    Services.Lighting.Technology = Enum.Technology.Compatibility
    
    pcall(function()
        settings().Rendering.QualityLevel = "Level01"
        settings().Rendering.MeshPartDetailLevel = Enum.MeshPartDetailLevel.Level01
    end)

    -- 2. Clean Specific Heavy Folders (Deep Scan Request)
    -- Membersihkan ToyFactory dan NPC sesuai permintaan
    local HeavyFolders = {
        Services.Workspace:FindFirstChild("ToyFactory"),
        Services.Workspace:FindFirstChild("NPC"),
        Services.Workspace:FindFirstChild("Props") -- Optional: Seringkali berat
    }

    for _, folder in pairs(HeavyFolders) do
        if folder then
            CleanVisuals(folder) -- Bersihkan visual di dalam folder ini
        end
    end

    -- 3. General Cleanup (Tanpa memindai seluruh workspace yang menyebabkan lag)
    local Terrain = Services.Workspace:FindFirstChildOfClass("Terrain")
    if Terrain then
        Terrain.WaterWaveSize = 0
        Terrain.WaterReflectance = 0
        Terrain.WaterTransparency = 0
        Terrain.Decoration = false
    end
    
    -- 4. Force Garbage Collection
    for i = 1, 3 do collectgarbage("collect") end
    
    local endMem = gcinfo()
    return math.floor(startMem - endMem)
end

-- ====================================================
-- [FPS MONITOR]
-- ====================================================
local fpsT = 0
Services.RunService.RenderStepped:Connect(function(dt)
    fpsT = fpsT + (1/dt - fpsT) * 0.1 
    local currentFps = math.floor(fpsT)
    if Title and currentFps then
        -- Update text hanya jika berubah drastis atau setiap beberapa frame agar ringan
        Title.Text = string.format(
            "SERAPHIN <font color=\"rgb(0,255,255)\">HELPER</font>  |  FPS: <b>%d</b>", 
            currentFps
        )
    end
end)

BtnFps.MouseButton1Click:Connect(function()
    local caps = {30, 60, 90, 144, 240, 99999}
    _G.fpsIndex = ((_G.fpsIndex or 5) % #caps) + 1
    local v = caps[_G.fpsIndex]
    if setfpscap then setfpscap(v) end
    local txt = (v > 1000) and "Max" or tostring(v)
    BtnFps.Text = "FPS: " .. txt
    ToggleVisual(BtnFps, true)
    task.wait(0.1)
    ToggleVisual(BtnFps, false)
end)

ToggleVisual(BtnPanel, true)
BtnPanel.MouseButton1Click:Connect(function()
    States.Panel = not States.Panel
    FloatHUD.Visible = States.Panel
    BtnPanel.Text = "Panel Info: " .. (States.Panel and "ON" or "OFF")
    ToggleVisual(BtnPanel, States.Panel)
end)

-- ====================================================
-- [5] BACKGROUND LOOPS (Optimized)
-- ====================================================

-- ANTI STUCK LOOP
task.spawn(function()
    while true do
        task.wait(1)
        if States.AntiStuck then
            pcall(function()
                local currentFish = 0
                local ls = Player:FindFirstChild("leaderstats")
                if ls and ls:FindFirstChild("Caught") then currentFish = ls.Caught.Value end

                if currentFish > LastFishCount then
                    LastFishCount = currentFish
                    LastFishCaughtTime = tick()
                else
                    if (tick() - LastFishCaughtTime) > States.StuckTimeout then
                        Notify("Anti-Stuck", "Stuck detected! Respawning...")
                        local stuckPos = HRP.CFrame 
                        if Hum then Hum.Health = 0 end
                        Player.CharacterAdded:Wait()
                        local newChar = Player.Character or Player.CharacterAdded:Wait()
                        local newHRP = newChar:WaitForChild("HumanoidRootPart", 10)
                        task.wait(1) 
                        if newHRP then newHRP.CFrame = stuckPos end
                        task.wait(0.5)
                        ForceEquipRod()
                        Notify("Anti-Stuck", "Recovered!")
                        LastFishCaughtTime = tick()
                        LastFishCount = currentFish 
                    end
                end
            end)
        else
            local ls = Player:FindFirstChild("leaderstats")
            if ls and ls:FindFirstChild("Caught") then LastFishCount = ls.Caught.Value end
            LastFishCaughtTime = tick()
        end
    end
end)

-- AUTO EVENT LOOP (Optimized)
task.spawn(function()
    while true do
        task.wait(2) -- Check setiap 2 detik (lebih ringan dari 1)
        if States.AutoEvent then
            pcall(function()
                if not HRP or not HRP.Parent then return end
                local Props = Services.Workspace:FindFirstChild("Props")
                local FoundEvent = nil
                
                -- Optimization: Jangan loop semua jika folder Props sangat besar
                if Props then
                    local children = Props:GetChildren()
                    for i = 1, math.min(#children, 50) do -- Hanya cek 50 item pertama jika event spawn di awal
                        local v = children[i]
                        if v:IsA("Model") or v:IsA("BasePart") then
                            FoundEvent = v
                            break 
                        end
                    end
                end

                if FoundEvent then
                    if not IsInEvent then
                        EventStartCFrame = HRP.CFrame 
                        IsInEvent = true
                        Notify("Auto Event", "Event Found!")
                    end
                    local targetPos = FoundEvent:GetPivot().Position
                    local destPos = Vector3.new(targetPos.X, 3, targetPos.Z)
                    if (HRP.Position - destPos).Magnitude > 10 then
                        HRP.CFrame = CFrame.new(destPos)
                    end
                    if not States.WoW then SetWoW(true) end
                else
                    if IsInEvent then
                        IsInEvent = false
                        Notify("Auto Event", "Event Done.")
                        if EventStartCFrame and HRP then 
                            HRP.CFrame = EventStartCFrame 
                            EventStartCFrame = nil 
                        end
                        if States.WoW then SetWoW(false) end
                    end
                end
            end)
        end
    end
end)

-- AUTO EQUIP LOOP
task.spawn(function()
    while true do
        task.wait(2) 
        if States.AutoEquip then ForceEquipRod() end
    end
end)

-- STATS UPDATE LOOP (Optimized for CPU)
task.spawn(function()
    while true do
        task.wait(0.8) -- Update UI kurang dari 1 detik sekali untuk meringankan CPU
        if States.Panel then
            pcall(function()
                -- 1. Fish Count
                local ls = Player:FindFirstChild("leaderstats")
                local caughtObj = ls and ls:FindFirstChild("Caught")
                local function formatNum(n) return tostring(n):reverse():gsub("%d%d%d", "%1,"):reverse():gsub("^,", "") end
                LblFishVal.Text = formatNum(caughtObj and caughtObj.Value or 0)
                
                -- 2. Backpack Count
                local bagText = "0/?"
                local backpackGui = Player:FindFirstChild("PlayerGui") and Player.PlayerGui:FindFirstChild("Backpack")
                
                if backpackGui then
                   local foundLabel = false
                   -- Optimization: Limit depth scan
                   for _, v in pairs(backpackGui:GetDescendants()) do
                        if v:IsA("TextLabel") and string.find(v.Text, "/") then 
                            bagText = v.Text 
                            foundLabel = true
                            break 
                        end
                    end
                    if not foundLabel and Player:FindFirstChild("Backpack") then
                        bagText = tostring(#Player.Backpack:GetChildren())
                    end
                else 
                     bagText = tostring(#Player:WaitForChild("Backpack"):GetChildren())
                end
                LblInvVal.Text = bagText
            end)
        end
    end
end)

-- ====================================================
-- [6] FUNCTION BUTTONS LOGIC
-- ====================================================

BtnStuckToggle.MouseButton1Click:Connect(function()
    States.AntiStuck = not States.AntiStuck
    if States.AntiStuck then
        BtnStuckToggle.Text = "Anti-Stuck: ON"
        ToggleVisual(BtnStuckToggle, true)
        local val = tonumber(BoxStuckInput.Text)
        if not val or val < 10 then val = 60; BoxStuckInput.Text = "60" end
        States.StuckTimeout = val
        LastFishCaughtTime = tick()
    else
        BtnStuckToggle.Text = "Anti-Stuck: OFF"
        ToggleVisual(BtnStuckToggle, false)
    end
end)

BoxStuckInput.FocusLost:Connect(function()
    local val = tonumber(BoxStuckInput.Text)
    if val then States.StuckTimeout = val else BoxStuckInput.Text = tostring(States.StuckTimeout) end
end)

BtnEquip.MouseButton1Click:Connect(function() SetAutoEquip(not States.AutoEquip) end)

BtnEvent.MouseButton1Click:Connect(function()
    States.AutoEvent = not States.AutoEvent
    BtnEvent.Text = "Auto Event: " .. (States.AutoEvent and "ON" or "OFF")
    ToggleVisual(BtnEvent, States.AutoEvent)
    if not States.AutoEvent then
        if IsInEvent and EventStartCFrame and HRP then HRP.CFrame = EventStartCFrame end
        IsInEvent = false
        SetWoW(false)
    end
end)

BtnFreeze.MouseButton1Click:Connect(function() 
    States.Freeze = not States.Freeze 
    if HRP then HRP.Anchored = States.Freeze end 
    BtnFreeze.Text = "Freeze: " .. (States.Freeze and "ON" or "OFF")
    ToggleVisual(BtnFreeze, States.Freeze) 
end)

BtnWow.MouseButton1Click:Connect(function() SetWoW(not States.WoW) end)

BtnNoclip.MouseButton1Click:Connect(function() 
    States.Noclip = not States.Noclip 
    BtnNoclip.Text = "No Clip: "..(States.Noclip and "ON" or "OFF") 
    ToggleVisual(BtnNoclip, States.Noclip) 
    if States.Noclip then 
        Connections["Noclip"] = Services.RunService.Stepped:Connect(function() 
            if Player.Character then 
                for _,v in pairs(Player.Character:GetDescendants()) do 
                    if v:IsA("BasePart") then v.CanCollide = false end 
                end 
            end 
        end) 
    else 
        if Connections["Noclip"] then Connections["Noclip"]:Disconnect() end 
    end 
end)

BtnBoost.MouseButton1Click:Connect(function() 
    States.Boost = not States.Boost 
    BtnBoost.Text = "CPU Booster: " .. (States.Boost and "ON" or "OFF")
    ToggleVisual(BtnBoost, States.Boost) 
    if States.Boost then
        local freed = OptimizePerformance()
        Notify("CPU Boost", "Graphics Optimized! (ToyFactory/NPC Cleaned)")
    else
        Notify("Info", "Settings saved (Rejoin to reset graphics)")
    end
end)

BtnRender.MouseButton1Click:Connect(function() 
    States.NoRender = not States.NoRender 
    Services.RunService:Set3dRenderingEnabled(not States.NoRender) 
    BtnRender.Text = "3D Render: "..(States.NoRender and "OFF" or "ON") 
    ToggleVisual(BtnRender, States.NoRender) 
end)

BtnRejoin.MouseButton1Click:Connect(function() Services.TeleportService:Teleport(game.PlaceId, Player) end)

BtnSave.MouseButton1Click:Connect(function() 
    if HRP then 
        SavedCFrame = HRP.CFrame 
        BtnSave.Text="SAVED" 
        task.delay(1, function() BtnSave.Text="Save Pos" end)
    end 
end)

BtnLoad.MouseButton1Click:Connect(function() 
    if SavedCFrame and HRP then HRP.CFrame = SavedCFrame end 
end)

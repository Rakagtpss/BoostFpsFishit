-- Booster + Ping UI (LocalScript)
-- Letakkan di StarterGui

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer
if not player then return end

-- GameSettings via UserSettings (bisa tidak ada di environment tertentu)
local successUserSettings, UserSettings = pcall(function() return UserSettings() end)
local GameSettings = successUserSettings and UserSettings and UserSettings.GameSettings or nil

-- UI buat
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "BoosterPingUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 240, 0, 110)
mainFrame.Position = UDim2.new(0, 12, 0, 12)
mainFrame.BackgroundColor3 = Color3.fromRGB(25,25,25)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

local uiCorner = Instance.new("UICorner", mainFrame)
uiCorner.CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, -16, 0, 28)
title.Position = UDim2.new(0, 8, 0, 8)
title.BackgroundTransparency = 1
title.Text = "Booster CPU + Ping"
title.TextColor3 = Color3.fromRGB(240,240,240)
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.TextXAlignment = Enum.TextXAlignment.Left

local pingLabel = Instance.new("TextLabel", mainFrame)
pingLabel.Size = UDim2.new(1, -16, 0, 28)
pingLabel.Position = UDim2.new(0, 8, 0, 36)
pingLabel.BackgroundTransparency = 1
pingLabel.Text = "Ping: -- ms"
pingLabel.TextColor3 = Color3.fromRGB(220,220,220)
pingLabel.Font = Enum.Font.SourceSans
pingLabel.TextSize = 16
pingLabel.TextXAlignment = Enum.TextXAlignment.Left

local boostButton = Instance.new("TextButton", mainFrame)
boostButton.Size = UDim2.new(1, -16, 0, 30)
boostButton.Position = UDim2.new(0, 8, 0, 68)
boostButton.Text = "Enable Boost"
boostButton.Font = Enum.Font.SourceSansBold
boostButton.TextSize = 16
boostButton.TextColor3 = Color3.fromRGB(20,20,20)
boostButton.BackgroundColor3 = Color3.fromRGB(125, 200, 75)
boostButton.AutoButtonColor = true
local bCorner = Instance.new("UICorner", boostButton)
bCorner.CornerRadius = UDim.new(0, 6)

-- State & storage untuk restore
local boosted = false
local savedState = {
    quality = nil,
    lighting = {},
    particles = {},
    decals = {}
}

-- Fungsi helper untuk save/disable visual effects
local function saveAndDisableVisuals()
    -- Save Quality
    if GameSettings then
        pcall(function()
            savedState.quality = GameSettings.SavedQualityLevel
            -- set to lowest (0 atau 1 tergantung environment), gunakan 1 agar kompatibel
            GameSettings.SavedQualityLevel = 1
        end)
    end

    -- Lighting changes
    pcall(function()
        savedState.lighting.GlobalShadows = Lighting.GlobalShadows
        savedState.lighting.FogEnd = Lighting.FogEnd
        savedState.lighting.Brightness = Lighting.Brightness
        -- apply lighter settings
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        Lighting.Brightness = math.max(1, Lighting.Brightness * 0.9)
    end)

    -- Disable particle emitters, trails, and make decals invisible (store previous)
    for _, obj in pairs(workspace:GetDescendants()) do
        if obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
            local ok, _ = pcall(function()
                savedState.particles[obj] = obj.Enabled
                obj.Enabled = false
            end)
        elseif obj:IsA("Decal") or obj:IsA("Texture") then
            local ok, _ = pcall(function()
                savedState.decals[obj] = obj.Transparency
                obj.Transparency = 1
            end)
        end
    end
end

local function restoreVisuals()
    -- Restore quality
    if GameSettings then
        pcall(function()
            if savedState.quality ~= nil then
                GameSettings.SavedQualityLevel = savedState.quality
            end
        end)
    end

    -- Restore lighting
    pcall(function()
        if savedState.lighting.GlobalShadows ~= nil then
            Lighting.GlobalShadows = savedState.lighting.GlobalShadows
        end
        if savedState.lighting.FogEnd ~= nil then
            Lighting.FogEnd = savedState.lighting.FogEnd
        end
        if savedState.lighting.Brightness ~= nil then
            Lighting.Brightness = savedState.lighting.Brightness
        end
    end)

    -- Restore particles
    for obj, enabled in pairs(savedState.particles) do
        if obj and obj.Parent then
            pcall(function() obj.Enabled = enabled end)
        end
    end
    savedState.particles = {}

    -- Restore decals
    for obj, trans in pairs(savedState.decals) do
        if obj and obj.Parent then
            pcall(function() obj.Transparency = trans end)
        end
    end
    savedState.decals = {}
end

-- Toggle fungsi
local function setBoost(state)
    if state == boosted then return end
    boosted = state
    if boosted then
        boostButton.Text = "Disable Boost"
        boostButton.BackgroundColor3 = Color3.fromRGB(220, 80, 80)
        -- enable boost
        saveAndDisableVisuals()
    else
        boostButton.Text = "Enable Boost"
        boostButton.BackgroundColor3 = Color3.fromRGB(125, 200, 75)
        -- restore
        restoreVisuals()
    end
end

boostButton.MouseButton1Click:Connect(function()
    setBoost(not boosted)
end)

-- Ping updater (menggunakan Player:GetNetworkPing())
spawn(function()
    while screenGui.Parent and player.Parent do
        local ok, ping = pcall(function()
            return player:GetNetworkPing()
        end)
        local ms = 0
        if ok and type(ping) == "number" then
            ms = math.floor(ping * 1000 + 0.5)
        end
        pingLabel.Text = ("Ping: %d ms"):format(ms)
        wait(0.5)
    end
end)

-- Clean up on leave/reset (restore)
player.AncestryChanged:Connect(function()
    if not player:IsDescendantOf(game) then
        restoreVisuals()
    end
end)
game:BindToClose(function()
    restoreVisuals()
end)

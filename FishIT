-- [1] SERVICES & SAFE LOAD
local Services = {
    Players = game:GetService("Players"),
    RunService = game:GetService("RunService"),
    CoreGui = game:GetService("CoreGui"),
    Lighting = game:GetService("Lighting"),
    TeleportService = game:GetService("TeleportService"),
    UserInputService = game:GetService("UserInputService"),
    ReplicatedStorage = game:GetService("ReplicatedStorage"),
    TweenService = game:GetService("TweenService"),
    Workspace = game:GetService("Workspace")
}

local Player = Services.Players.LocalPlayer
local Char = Player.Character or Player.CharacterAdded:Wait()
local HRP = Char:WaitForChild("HumanoidRootPart", 10)
local Hum = Char:WaitForChild("Humanoid", 10)

-- // Konfigurasi Visual (DARK GREY & BRIGHT WHITE TEXT)
local UI_THEME = {
    MainWidth = 420,  
    MainHeight = 260, 
    BgColor = Color3.fromRGB(35, 35, 35),       
    SidebarColor = Color3.fromRGB(25, 25, 25), 
    Accent = Color3.fromRGB(120, 120, 120),   -- Aksen Grey Silver
    TextColor = Color3.fromRGB(255, 255, 255), -- [UBAH] Putih Terang Mutlak
    SubTextColor = Color3.fromRGB(220, 220, 220), -- [UBAH] Putih sedikit soft
    Font = Enum.Font.GothamBold, -- Font Tebal agar Jelas
    BtnFont = Enum.Font.GothamBold -- Tombol juga pakai Bold agar jelas walau kecil
}

-- Bersihkan UI Lama
if Services.CoreGui:FindFirstChild("SeraphinHelper") then Services.CoreGui.SeraphinHelper:Destroy() end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SeraphinHelper"
ScreenGui.Parent = Services.CoreGui
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- ====================================================
-- [SYSTEM] CUSTOM NOTIFICATION
-- ====================================================
local NotifyContainer = Instance.new("Frame", ScreenGui)
NotifyContainer.Name = "NotificationContainer"
NotifyContainer.Size = UDim2.new(0, 260, 0.6, 0)
NotifyContainer.AnchorPoint = Vector2.new(1, 1)
NotifyContainer.Position = UDim2.new(1, -20, 1, -20)
NotifyContainer.BackgroundTransparency = 1
NotifyContainer.ClipsDescendants = false

local NotifyLayout = Instance.new("UIListLayout", NotifyContainer)
NotifyLayout.FillDirection = Enum.FillDirection.Vertical
NotifyLayout.VerticalAlignment = Enum.VerticalAlignment.Bottom
NotifyLayout.SortOrder = Enum.SortOrder.LayoutOrder
NotifyLayout.Padding = UDim.new(0, 6)

local function Notify(title, text, colorOverride, duration)
    local color = colorOverride or UI_THEME.Accent
    local timeTime = duration or 4 
    
    local Frame = Instance.new("Frame")
    Frame.Name = "NotifyItem"
    Frame.Size = UDim2.new(1, 0, 0, 0)
    Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Frame.BackgroundTransparency = 0.15
    Frame.BorderSizePixel = 0
    Frame.Parent = NotifyContainer
    
    local Stroke = Instance.new("UIStroke", Frame)
    Stroke.Color = color
    Stroke.Thickness = 1.5
    Stroke.Transparency = 0
    
    Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
    
    local LblTitle = Instance.new("TextLabel", Frame)
    LblTitle.Size = UDim2.new(1, -12, 0, 20)
    LblTitle.Position = UDim2.new(0, 12, 0, 4)
    LblTitle.BackgroundTransparency = 1
    LblTitle.Text = string.upper(title)
    LblTitle.TextColor3 = color
    LblTitle.Font = Enum.Font.GothamBlack
    LblTitle.TextSize = 15
    LblTitle.TextXAlignment = Enum.TextXAlignment.Left
    
    local LblMsg = Instance.new("TextLabel", Frame)
    LblMsg.Size = UDim2.new(1, -12, 0, 20)
    LblMsg.Position = UDim2.new(0, 12, 0, 22)
    LblMsg.BackgroundTransparency = 1
    LblMsg.Text = text
    LblMsg.TextColor3 = Color3.fromRGB(255, 255, 255)
    LblMsg.Font = Enum.Font.GothamBold
    LblMsg.TextSize = 12
    LblMsg.TextXAlignment = Enum.TextXAlignment.Left

    local TweenIn = Services.TweenService:Create(Frame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, 50)})
    TweenIn:Play()
    
    task.delay(timeTime, function()
        if Frame then
            local TweenOut = Services.TweenService:Create(Frame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
                Size = UDim2.new(1, 0, 0, 0), 
                BackgroundTransparency = 1
            })
            TweenOut:Play()
            if Stroke then Services.TweenService:Create(Stroke, TweenInfo.new(0.2), {Transparency = 1}):Play() end
            if LblTitle then Services.TweenService:Create(LblTitle, TweenInfo.new(0.2), {TextTransparency = 1}):Play() end
            if LblMsg then Services.TweenService:Create(LblMsg, TweenInfo.new(0.2), {TextTransparency = 1}):Play() end
            
            TweenOut.Completed:Wait()
            Frame:Destroy()
        end
    end)
end

Notify("SERAPHIN", "Script Updated - @828_Raka", UI_THEME.Accent, 2.5)

-- ====================================================
-- [UI CONSTRUCTION] SIDE UI LAYOUT
-- ====================================================

-- 1. Main Frame
local Main = Instance.new("Frame", ScreenGui)
Main.Name = "Main"
Main.Size = UDim2.new(0, UI_THEME.MainWidth, 0, UI_THEME.MainHeight)
Main.Position = UDim2.new(0.5, -UI_THEME.MainWidth/2, 0.4, 0)
Main.BackgroundColor3 = UI_THEME.BgColor
Main.BackgroundTransparency = 0.1
Main.ClipsDescendants = true 
Main.Visible = false -- Hidden on start

local MainCorner = Instance.new("UICorner", Main)
MainCorner.CornerRadius = UDim.new(0, 8)
local MainStroke = Instance.new("UIStroke", Main)
MainStroke.Color = UI_THEME.Accent
MainStroke.Thickness = 1.5
MainStroke.Transparency = 0

-- 2. Sidebar (Left)
local Sidebar = Instance.new("Frame", Main)
Sidebar.Name = "Sidebar"
Sidebar.Size = UDim2.new(0, 110, 1, 0)
Sidebar.BackgroundColor3 = UI_THEME.SidebarColor
Sidebar.BorderSizePixel = 0

local SidebarLine = Instance.new("Frame", Sidebar)
SidebarLine.Size = UDim2.new(0, 1, 1, 0)
SidebarLine.Position = UDim2.new(1, -1, 0, 0)
SidebarLine.BackgroundColor3 = UI_THEME.Accent
SidebarLine.BackgroundTransparency = 0.5
SidebarLine.BorderSizePixel = 0

-- Header di Sidebar
local Header = Instance.new("Frame", Sidebar)
Header.Size = UDim2.new(1, 0, 0, 50)
Header.BackgroundTransparency = 1

local Title = Instance.new("TextLabel", Header)
Title.Size = UDim2.new(1, -10, 1, 0)
Title.Position = UDim2.new(0, 5, 0, 0)
Title.Text = "SERAPHIN\n<font size='10' color='rgb(200,200,200)'>HELPER</font>"
Title.RichText = true
Title.TextColor3 = UI_THEME.TextColor
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 14
Title.BackgroundTransparency = 1
Title.TextYAlignment = Enum.TextYAlignment.Center

-- Tab Container
local TabContainer = Instance.new("Frame", Sidebar)
TabContainer.Size = UDim2.new(1, 0, 1, -80)
TabContainer.Position = UDim2.new(0, 0, 0, 50)
TabContainer.BackgroundTransparency = 1

local TabListLayout = Instance.new("UIListLayout", TabContainer)
TabListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
TabListLayout.SortOrder = Enum.SortOrder.LayoutOrder
TabListLayout.Padding = UDim.new(0, 5)

-- Footer (FPS & Hide)
local Footer = Instance.new("Frame", Sidebar)
Footer.Size = UDim2.new(1, 0, 0, 30)
Footer.Position = UDim2.new(0, 0, 1, -30)
Footer.BackgroundTransparency = 1

local FpsLabel = Instance.new("TextLabel", Footer)
FpsLabel.Size = UDim2.new(1, 0, 1, 0)
FpsLabel.BackgroundTransparency = 1
FpsLabel.Text = "FPS: 60"
FpsLabel.TextColor3 = UI_THEME.SubTextColor
FpsLabel.Font = Enum.Font.GothamBold
FpsLabel.TextSize = 10

-- 3. Content Area (Right)
local Content = Instance.new("Frame", Main)
Content.Name = "Content"
Content.Size = UDim2.new(1, -110, 1, 0)
Content.Position = UDim2.new(0, 110, 0, 0)
Content.BackgroundTransparency = 1

-- Pages
local PageMain = Instance.new("Frame", Content)
PageMain.Name = "PageMain"
PageMain.Size = UDim2.new(1, -20, 1, -20)
PageMain.Position = UDim2.new(0, 10, 0, 10)
PageMain.BackgroundTransparency = 1
PageMain.Visible = true

local PageEnchant = Instance.new("Frame", Content)
PageEnchant.Name = "PageEnchant"
PageEnchant.Size = UDim2.new(1, -20, 1, -20)
PageEnchant.Position = UDim2.new(0, 10, 0, 10)
PageEnchant.BackgroundTransparency = 1
PageEnchant.Visible = false

local PageMisc = Instance.new("Frame", Content)
PageMisc.Name = "PageMisc"
PageMisc.Size = UDim2.new(1, -20, 1, -20)
PageMisc.Position = UDim2.new(0, 10, 0, 10)
PageMisc.BackgroundTransparency = 1
PageMisc.Visible = false

-- Grids
local GridMain = Instance.new("UIGridLayout", PageMain)
GridMain.CellSize = UDim2.new(0, 140, 0, 24) -- [UBAH] Tinggi tombol diperkecil (24)
GridMain.CellPadding = UDim2.new(0, 8, 0, 8)
GridMain.HorizontalAlignment = Enum.HorizontalAlignment.Left

local GridMisc = Instance.new("UIGridLayout", PageMisc)
GridMisc.CellSize = UDim2.new(0, 140, 0, 24) -- [UBAH] Tinggi tombol diperkecil (24)
GridMisc.CellPadding = UDim2.new(0, 8, 0, 8)
GridMisc.HorizontalAlignment = Enum.HorizontalAlignment.Left

-- Drag Logic
local function EnableDrag(frame, dragInputObj)
    local dragToggle, dragStart, startPos
    local function updateInput(input)
        local delta = input.Position - dragStart
        local position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        frame.Position = position
    end
    dragInputObj.InputBegan:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) then
            dragToggle = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragToggle = false
                end
            end)
        end
    end)
    dragInputObj.InputChanged:Connect(function(input)
        if (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local dragInput = input
            Services.UserInputService.InputChanged:Connect(function(inputCheck)
                if inputCheck == dragInput and dragToggle then
                    updateInput(inputCheck)
                end
            end)
        end
    end)
end
EnableDrag(Main, Sidebar) -- Drag handle is the sidebar

-- ====================================================
-- [UI HELPERS] TABS & BUTTONS
-- ====================================================

local function CreateTabBtn(text, order)
    local btn = Instance.new("TextButton", TabContainer)
    btn.Size = UDim2.new(1, -10, 0, 28)
    btn.BackgroundColor3 = Color3.fromRGB(0,0,0)
    btn.BackgroundTransparency = 1
    btn.Text = text
    btn.TextColor3 = UI_THEME.SubTextColor
    btn.Font = UI_THEME.BtnFont
    btn.TextSize = 11
    btn.LayoutOrder = order
    btn.AutoButtonColor = false
    
    local ind = Instance.new("Frame", btn)
    ind.Name = "Indicator"
    ind.Size = UDim2.new(0, 3, 1, 0)
    ind.Position = UDim2.new(0, 0, 0, 0)
    ind.BackgroundColor3 = UI_THEME.Accent
    ind.BackgroundTransparency = 1 
    
    return btn
end

local TabMainBtn = CreateTabBtn("MAIN", 1)
local TabEnchBtn = CreateTabBtn("ENCHANT", 2)
local TabMiscBtn = CreateTabBtn("MISC", 3)

local function SetTabActive(btn, active)
    if active then
        btn.TextColor3 = UI_THEME.TextColor
        btn.Font = Enum.Font.GothamBold
        btn.BackgroundTransparency = 0.9
        btn.BackgroundColor3 = Color3.fromRGB(255,255,255)
        btn.Indicator.BackgroundTransparency = 0
    else
        btn.TextColor3 = UI_THEME.SubTextColor
        btn.Font = UI_THEME.BtnFont
        btn.BackgroundTransparency = 1
        btn.Indicator.BackgroundTransparency = 1
    end
end

local function SwitchTab(tabName)
    PageMain.Visible = false
    PageEnchant.Visible = false
    PageMisc.Visible = false
    
    SetTabActive(TabMainBtn, false)
    SetTabActive(TabEnchBtn, false)
    SetTabActive(TabMiscBtn, false)
    
    if tabName == "Main" then
        PageMain.Visible = true
        SetTabActive(TabMainBtn, true)
    elseif tabName == "Enchant" then
        PageEnchant.Visible = true
        SetTabActive(TabEnchBtn, true)
    elseif tabName == "Misc" then
        PageMisc.Visible = true
        SetTabActive(TabMiscBtn, true)
    end
end

TabMainBtn.MouseButton1Click:Connect(function() SwitchTab("Main") end)
TabEnchBtn.MouseButton1Click:Connect(function() SwitchTab("Enchant") end)
TabMiscBtn.MouseButton1Click:Connect(function() SwitchTab("Misc") end)

-- Default Tab
SwitchTab("Main")

-- Helper Button Maker
local function MakeBtn(parent, text)
    local b = Instance.new("TextButton", parent)
    b.Text = text
    b.BackgroundColor3 = Color3.fromRGB(0, 0, 0) 
    b.BackgroundTransparency = 0.5
    b.TextColor3 = UI_THEME.TextColor
    b.Font = UI_THEME.BtnFont 
    b.TextSize = 10 
    b.AutoButtonColor = true
    b.ClipsDescendants = true
    Instance.new("UICorner", b).CornerRadius = UDim.new(0, 4) 
    local s = Instance.new("UIStroke", b)
    s.Color = UI_THEME.Accent 
    s.Thickness = 1
    s.Transparency = 0.6
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    return b
end

local function ToggleVisual(btn, on)
    if on then
        btn.BackgroundColor3 = UI_THEME.Accent 
        btn.BackgroundTransparency = 0.2
        btn.TextColor3 = Color3.fromRGB(255, 255, 255) 
        btn.UIStroke.Transparency = 1
        btn.Font = Enum.Font.GothamBold
    else
        btn.BackgroundColor3 = Color3.fromRGB(0, 0, 0) 
        btn.BackgroundTransparency = 0.5
        btn.TextColor3 = UI_THEME.TextColor
        btn.UIStroke.Transparency = 0.6
        btn.Font = UI_THEME.BtnFont
    end
end

-- ====================================================
-- [UI ELEMENTS CREATION]
-- ====================================================

-- >> TAB: MAIN <<
local BtnEvent  = MakeBtn(PageMain, "Auto Event: OFF") 
local BtnEquip  = MakeBtn(PageMain, "Auto Equip: OFF")
local BtnUltra  = MakeBtn(PageMain, "Ultra HD: OFF") 
local BtnWow    = MakeBtn(PageMain, "Water Walk: OFF")
local BtnFreeze = MakeBtn(PageMain, "Freeze: OFF")
local BtnNoclip = MakeBtn(PageMain, "No Clip: OFF")
local BtnBoost  = MakeBtn(PageMain, "CPU Booster: OFF") 
local BtnRender = MakeBtn(PageMain, "3D Render: ON") 
local BtnFps    = MakeBtn(PageMain, "FPS: Unli")

-- >> TAB: ENCHANT (Dedicated Page) <<
local EnchTitle = Instance.new("TextLabel", PageEnchant)
EnchTitle.Size = UDim2.new(1, 0, 0, 20)
EnchTitle.BackgroundTransparency = 1
EnchTitle.Text = "AUTO SELL ENCHANT"
EnchTitle.TextColor3 = UI_THEME.TextColor -- Bright White
EnchTitle.Font = Enum.Font.GothamBlack
EnchTitle.TextSize = 14

-- Info/Count Label (Dipindah ke tengah atas)
local LblOwnedInfo = Instance.new("TextLabel", PageEnchant)
LblOwnedInfo.Name = "LblOwned"
LblOwnedInfo.Size = UDim2.new(1, 0, 0, 25)
LblOwnedInfo.Position = UDim2.new(0, 0, 0.25, 0)
LblOwnedInfo.BackgroundTransparency = 1
LblOwnedInfo.Text = "Enchant Stone: ..." -- [UBAH] Nama Label
LblOwnedInfo.TextColor3 = UI_THEME.TextColor -- Bright White
LblOwnedInfo.Font = Enum.Font.GothamBold
LblOwnedInfo.TextSize = 14

-- Input Box (Tengah)
local BoxSellCount = Instance.new("TextBox", PageEnchant)
BoxSellCount.Name = "Input"
BoxSellCount.Size = UDim2.new(0.6, 0, 0, 30)
BoxSellCount.Position = UDim2.new(0.2, 0, 0.45, 0)
BoxSellCount.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BoxSellCount.BackgroundTransparency = 0.5
BoxSellCount.Text = "1"
BoxSellCount.PlaceholderText = "Amount"
BoxSellCount.TextColor3 = UI_THEME.TextColor -- Bright White
BoxSellCount.Font = Enum.Font.GothamBold
BoxSellCount.TextSize = 14
Instance.new("UICorner", BoxSellCount).CornerRadius = UDim.new(0, 4)
local sBox = Instance.new("UIStroke", BoxSellCount)
sBox.Color = UI_THEME.Accent
sBox.Thickness = 1
sBox.Transparency = 0.6

-- Sell Button (PALING BAWAH)
local BtnSellStones = Instance.new("TextButton", PageEnchant)
BtnSellStones.Size = UDim2.new(0.8, 0, 0, 30) -- Lebar tapi tidak terlalu tinggi
BtnSellStones.Position = UDim2.new(0.1, 0, 0.85, 0) -- [UBAH] Posisi Bawah Sekali
BtnSellStones.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BtnSellStones.BackgroundTransparency = 0.5
BtnSellStones.Text = "SELL SELECTED AMOUNT"
BtnSellStones.TextColor3 = Color3.fromRGB(255, 80, 80) -- Merah Warning
BtnSellStones.Font = Enum.Font.GothamBlack
BtnSellStones.TextSize = 11 -- [UBAH] Kecil tapi Jelas
Instance.new("UICorner", BtnSellStones).CornerRadius = UDim.new(0, 4)
local sSell = Instance.new("UIStroke", BtnSellStones)
sSell.Color = Color3.fromRGB(255, 80, 80)
sSell.Thickness = 1
sSell.Transparency = 0.6

-- >> TAB: MISC <<
local StuckContainer = Instance.new("Frame", PageMisc)
StuckContainer.Size = UDim2.new(0, 288, 0, 24) -- [UBAH] Tinggi 24
StuckContainer.BackgroundTransparency = 1

local BtnStuckToggle = Instance.new("TextButton", StuckContainer)
BtnStuckToggle.Size = UDim2.new(0.65, -4, 1, 0)
BtnStuckToggle.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BtnStuckToggle.BackgroundTransparency = 0.5
BtnStuckToggle.Text = "Anti-Stuck: OFF"
BtnStuckToggle.TextColor3 = UI_THEME.TextColor
BtnStuckToggle.Font = UI_THEME.BtnFont
BtnStuckToggle.TextSize = 10
Instance.new("UICorner", BtnStuckToggle).CornerRadius = UDim.new(0, 4)
local s1 = Instance.new("UIStroke", BtnStuckToggle)
s1.Color = UI_THEME.Accent
s1.Thickness = 1
s1.Transparency = 0.6

local BoxStuckInput = Instance.new("TextBox", StuckContainer)
BoxStuckInput.Size = UDim2.new(0.35, 0, 1, 0)
BoxStuckInput.Position = UDim2.new(0.65, 0, 0, 0)
BoxStuckInput.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
BoxStuckInput.BackgroundTransparency = 0.5
BoxStuckInput.Text = "60" 
BoxStuckInput.PlaceholderText = "Sec"
BoxStuckInput.TextColor3 = UI_THEME.TextColor
BoxStuckInput.Font = Enum.Font.GothamBold
BoxStuckInput.TextSize = 10
Instance.new("UICorner", BoxStuckInput).CornerRadius = UDim.new(0, 4)
local s2 = Instance.new("UIStroke", BoxStuckInput)
s2.Color = UI_THEME.Accent
s2.Thickness = 1
s2.Transparency = 0.6

local BtnSave   = MakeBtn(PageMisc, "Save Pos")
local BtnLoad   = MakeBtn(PageMisc, "Load Pos")
local BtnRejoin = MakeBtn(PageMisc, "Rejoin Server")
local BtnPanel  = MakeBtn(PageMisc, "Panel Info: ON")

-- ====================================================
-- [LOGIC & STATES]
-- ====================================================
local States = {
    Freeze=false, WoW=false, Boost=false, Ultra=false, NoRender=false, 
    Noclip=false, Panel=true, AutoEquip=false, 
    AutoEvent=false, AntiStuck=false, StuckTimeout=60 
}
local SavedCFrame = nil 
local EventStartCFrame = nil 
local IsInEvent = false 
local Connections = {}
local BodyV = nil
local LastFishCaughtTime = tick()
local LastFishCount = 0

-- Floating HUD Logic (Retained)
local FloatHUD = Instance.new("Frame", ScreenGui)
FloatHUD.Name = "FloatingStats"
FloatHUD.Size = UDim2.new(0, 140, 0, 80) 
FloatHUD.Position = UDim2.new(0.85, 0, 0.4, 0)
FloatHUD.BackgroundColor3 = UI_THEME.BgColor
FloatHUD.BackgroundTransparency = 0.3
FloatHUD.Visible = false 
Instance.new("UICorner", FloatHUD).CornerRadius = UDim.new(0, 8)
Instance.new("UIStroke", FloatHUD).Color = UI_THEME.Accent

local FHudLayout = Instance.new("UIListLayout", FloatHUD)
FHudLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
FHudLayout.Padding = UDim.new(0, 5)
local FPad = Instance.new("UIPadding", FloatHUD)
FPad.PaddingTop = UDim.new(0,10)

local LblFishVal = Instance.new("TextLabel", FloatHUD)
LblFishVal.Size = UDim2.new(1,0,0,20)
LblFishVal.BackgroundTransparency = 1
LblFishVal.Text = "FISH: ..."
LblFishVal.TextColor3 = UI_THEME.TextColor -- Bright White
LblFishVal.Font = Enum.Font.GothamBold
LblFishVal.TextSize = 12

local LblInvVal = Instance.new("TextLabel", FloatHUD)
LblInvVal.Size = UDim2.new(1,0,0,20)
LblInvVal.BackgroundTransparency = 1
LblInvVal.Text = "BAG: ..."
LblInvVal.TextColor3 = UI_THEME.SubTextColor
LblInvVal.Font = Enum.Font.GothamBold
LblInvVal.TextSize = 12

EnableDrag(FloatHUD, FloatHUD)

-- ====================================================
-- [LOGIC IMPLEMENTATION]
-- ====================================================

-- Force Re-Equip
local function ForceEquipRod()
    pcall(function()
        local args = { [1] = 1 }
        local pkgs = Services.ReplicatedStorage:FindFirstChild("Packages")
        if pkgs then
            local idx = pkgs:FindFirstChild("_Index")
            if idx then
                local remote = idx:FindFirstChild("sleitnick_net@0.2.0")
                if remote then
                    remote.net:FindFirstChild("RE/EquipToolFromHotbar"):FireServer(unpack(args))
                end
            end
        end
    end)
end

-- Water Walk
local function SetWoW(bool)
    States.WoW = bool
    BtnWow.Text = "Water Walk: " .. (States.WoW and "ON" or "OFF")
    ToggleVisual(BtnWow, States.WoW)
    
    if States.WoW then 
        if not HRP or not HRP.Parent then return end 
        if not BodyV then 
            BodyV = Instance.new("BodyVelocity")
            BodyV.Name = "WoW_Velocity"
            BodyV.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            BodyV.Velocity = Vector3.zero
        end
        BodyV.Parent = HRP
        if Connections["WoW"] then Connections["WoW"]:Disconnect() end 
        Connections["WoW"] = Services.RunService.RenderStepped:Connect(function() 
            if HRP and Hum and BodyV and BodyV.Parent then
                local moveDir = Hum.MoveDirection
                if moveDir.Magnitude > 0 then
                    local speed = Hum.WalkSpeed
                    BodyV.Velocity = Vector3.new(moveDir.X * speed, 0, moveDir.Z * speed)
                else
                    BodyV.Velocity = Vector3.zero
                end
            end 
        end) 
    else 
        if Connections["WoW"] then Connections["WoW"]:Disconnect() end 
        if BodyV then BodyV:Destroy(); BodyV = nil end 
    end 
end

-- Auto Equip
local function SetAutoEquip(bool)
    States.AutoEquip = bool
    BtnEquip.Text = "Auto Equip: " .. (States.AutoEquip and "ON" or "OFF")
    ToggleVisual(BtnEquip, States.AutoEquip)
end

-- Ultra Graphics
local function SetUltraGraphics(enabled)
    States.Ultra = enabled
    BtnUltra.Text = "Ultra HD: " .. (States.Ultra and "ON" or "OFF")
    ToggleVisual(BtnUltra, States.Ultra)

    if enabled then
        pcall(function() settings().Rendering.QualityLevel = "Level21" end)
        Services.Lighting.GlobalShadows = true
        Services.Lighting.Technology = Enum.Technology.Future 
        Services.Lighting.EnvironmentDiffuseScale = 1
        Services.Lighting.EnvironmentSpecularScale = 1
        Notify("GRAPHICS", "ULTRA HD ACTIVE", Color3.fromRGB(0, 255, 255))
    else
        Services.Lighting.Technology = Enum.Technology.ShadowMap 
        Services.Lighting.EnvironmentDiffuseScale = 0
        Services.Lighting.EnvironmentSpecularScale = 0
        Notify("GRAPHICS", "Returned to Normal", UI_THEME.Accent)
    end
end

-- CPU Booster
local function SmartBoostTick()
    if not States.Boost then return end
    Services.Lighting.GlobalShadows = false
    Services.Lighting.Brightness = 0
    pcall(function() settings().Rendering.QualityLevel = "Level01" end)
    for _, v in pairs(Services.Workspace:GetDescendants()) do
        if v:IsA("BasePart") and v.Material ~= Enum.Material.SmoothPlastic then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
            v.CastShadow = false
        elseif v:IsA("Decal") or v:IsA("Texture") then
            if v.Transparency < 1 then v.Transparency = 1 end
        elseif v:IsA("ParticleEmitter") or v:IsA("Trail") then
            if v.Enabled then v.Enabled = false end
        end
    end
    local Terrain = Services.Workspace:FindFirstChildOfClass("Terrain")
    if Terrain then Terrain.WaterWaveSize = 0; Terrain.WaterReflectance = 0; Terrain.WaterTransparency = 0 end
end

local function ToggleBoost(enable)
    States.Boost = enable
    BtnBoost.Text = "CPU Booster: " .. (States.Boost and "ON" or "OFF")
    ToggleBoost(BtnBoost, States.Boost)

    if enable then
        if States.Ultra then SetUltraGraphics(false) end
        Notify("BOOSTER", "Smart Boost Active", Color3.fromRGB(0, 255, 100))
        SmartBoostTick()
        if Connections["BoostLoop"] then Connections["BoostLoop"]:Disconnect() end
        Connections["BoostLoop"] = task.spawn(function()
            while States.Boost do task.wait(3); SmartBoostTick() end
        end)
    else
        if Connections["BoostLoop"] then cancel(Connections["BoostLoop"]) end
        Notify("BOOSTER", "Restoring Graphics...", UI_THEME.Accent)
    end
end

-- FPS Monitor
local fpsT = 0
Services.RunService.RenderStepped:Connect(function(dt)
    fpsT = fpsT + (1/dt - fpsT) * 0.1 
    local currentFps = math.floor(fpsT)
    if FpsLabel then FpsLabel.Text = "FPS: " .. currentFps end
end)

BtnFps.MouseButton1Click:Connect(function()
    local caps = {60, 90, 144, 240, 99999}
    _G.fpsIndex = (_G.fpsIndex or 0) % #caps + 1 
    local v = caps[_G.fpsIndex]
    if setfpscap then setfpscap(v) end
    local txt = (v >= 9999) and "Unli" or tostring(v)
    BtnFps.Text = "FPS: " .. txt
    ToggleVisual(BtnFps, true)
    task.wait(0.1)
    ToggleVisual(BtnFps, false)
end)

ToggleVisual(BtnPanel, true)
BtnPanel.MouseButton1Click:Connect(function()
    States.Panel = not States.Panel
    FloatHUD.Visible = States.Panel
    BtnPanel.Text = "Panel Info: " .. (States.Panel and "ON" or "OFF")
    ToggleVisual(BtnPanel, States.Panel)
end)

-- Button Connections (Misc & Main)
BtnEquip.MouseButton1Click:Connect(function() SetAutoEquip(not States.AutoEquip) end)
BtnFreeze.MouseButton1Click:Connect(function() 
    States.Freeze = not States.Freeze; if HRP then HRP.Anchored = States.Freeze end
    BtnFreeze.Text = "Freeze: " .. (States.Freeze and "ON" or "OFF"); ToggleVisual(BtnFreeze, States.Freeze)
end)
BtnWow.MouseButton1Click:Connect(function() SetWoW(not States.WoW) end)
BtnNoclip.MouseButton1Click:Connect(function() 
    States.Noclip = not States.Noclip; BtnNoclip.Text = "No Clip: "..(States.Noclip and "ON" or "OFF"); ToggleVisual(BtnNoclip, States.Noclip)
    if States.Noclip then Connections["Noclip"] = Services.RunService.Stepped:Connect(function() 
        if Player.Character then for _,v in pairs(Player.Character:GetDescendants()) do if v:IsA("BasePart") then v.CanCollide = false end end end 
    end) else if Connections["Noclip"] then Connections["Noclip"]:Disconnect() end end
end)
BtnBoost.MouseButton1Click:Connect(function() ToggleBoost(not States.Boost) end)
BtnUltra.MouseButton1Click:Connect(function() if States.Boost then ToggleBoost(false) end; SetUltraGraphics(not States.Ultra) end)
BtnRender.MouseButton1Click:Connect(function() 
    States.NoRender = not States.NoRender; Services.RunService:Set3dRenderingEnabled(not States.NoRender)
    BtnRender.Text = "3D Render: "..(States.NoRender and "OFF" or "ON"); ToggleVisual(BtnRender, States.NoRender)
end)
BtnRejoin.MouseButton1Click:Connect(function() Services.TeleportService:Teleport(game.PlaceId, Player) end)
BtnSave.MouseButton1Click:Connect(function() if HRP then SavedCFrame = HRP.CFrame; Notify("POSITION", "Location Saved!", UI_THEME.Accent) end end)
BtnLoad.MouseButton1Click:Connect(function() if SavedCFrame and HRP then HRP.CFrame = SavedCFrame; Notify("POSITION", "Location Loaded!", UI_THEME.Accent) end end)
BtnStuckToggle.MouseButton1Click:Connect(function()
    States.AntiStuck = not States.AntiStuck
    BtnStuckToggle.Text = "Anti-Stuck: " .. (States.AntiStuck and "ON" or "OFF")
    ToggleVisual(BtnStuckToggle, States.AntiStuck)
    local val = tonumber(BoxStuckInput.Text); if not val or val < 10 then val = 60; BoxStuckInput.Text = "60" end
    States.StuckTimeout = val; LastFishCaughtTime = tick()
end)

-- ====================================================
-- [SELL ENCHANT LOGIC - DEEP SCANNED]
-- ====================================================

local function GetEnchantData()
    local stones = {}
    pcall(function()
        local inventoryData = nil
        local success, res = pcall(function() return require(Services.ReplicatedStorage.Controllers.InventoryController).Inventory end)
        if success then inventoryData = res end
        if not inventoryData then
            pcall(function() local mod = require(game:GetService("CorePackages").Workspace.Packages._Workspace.ProfilePlatform.ProfilePlatform.Components.Inventory); inventoryData = mod.Inventory or mod end)
        end
        if inventoryData then
            for _, item in pairs(inventoryData) do
                if item.Name == "Enchant Stones" or item.Name == "Enchant Stone" then table.insert(stones, item.Id or item.UUID or item.Guid) end
            end
        end
    end)
    -- Fallback UI Scan
    if #stones == 0 then
        local PG = Player:FindFirstChild("PlayerGui")
        if PG then
            for _, desc in pairs(PG:GetDescendants()) do
                if desc:IsA("TextLabel") and (string.find(desc.Text, "Enchant Stone")) then
                    local parent = desc.Parent
                    local foundID = parent:GetAttribute("ItemId") or parent:GetAttribute("Guid")
                    if foundID and not table.find(stones, foundID) then table.insert(stones, foundID) end
                end
            end
        end
    end
    return stones
end

-- Loop update "Owned" count
task.spawn(function()
    while true do
        if Main.Visible and PageEnchant.Visible then
            local myStones = GetEnchantData()
            -- [UBAH] Label sesuai request
            LblOwnedInfo.Text = "Enchant Stone: " .. #myStones
        end
        task.wait(1)
    end
end)

BtnSellStones.MouseButton1Click:Connect(function()
    local amountToSell = tonumber(BoxSellCount.Text)
    if not amountToSell or amountToSell <= 0 then Notify("ERROR", "Invalid Amount!", Color3.fromRGB(255, 50, 50)); return end

    local myStones = GetEnchantData()
    local totalOwned = #myStones

    if totalOwned == 0 then Notify("SYSTEM", "No Stones Found!", Color3.fromRGB(255, 100, 100)); return end

    local actualSellCount = math.min(amountToSell, totalOwned)
    Notify("SELLING", "Selling " .. actualSellCount .. " stones...", Color3.fromRGB(255, 255, 0))

    local Net = Services.ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index"):WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net")
    local EquipRemote = Net:WaitForChild("RE/EquipItem")
    local SellRemote = Net:WaitForChild("RF/SellItem")

    task.spawn(function()
        for i = 1, actualSellCount do
            local guid = myStones[i]
            if guid then
                EquipRemote:FireServer(guid, "Enchant Stones")
                SellRemote:InvokeServer(guid, 1) -- Keep strict 1 per loop safety
                BtnSellStones.Text = "Selling: " .. i .. "/" .. actualSellCount
            end
            task.wait(0.1)
        end
        BtnSellStones.Text = "SELL SELECTED AMOUNT"
        Notify("SUCCESS", "Sold " .. actualSellCount .. " Stones!", UI_THEME.Accent)
        local sisa = GetEnchantData()
        LblOwnedInfo.Text = "Enchant Stone: " .. #sisa
    end)
end)

-- ====================================================
-- [BACKGROUND LOOPS]
-- ====================================================

-- Anti Stuck
task.spawn(function()
    while true do
        task.wait(1)
        if States.AntiStuck then
            pcall(function()
                local currentFish = 0
                local ls = Player:FindFirstChild("leaderstats")
                if ls and ls:FindFirstChild("Caught") then currentFish = ls.Caught.Value end
                if currentFish > LastFishCount then
                    LastFishCount = currentFish; LastFishCaughtTime = tick()
                else
                    if (tick() - LastFishCaughtTime) > States.StuckTimeout then
                        Notify("ANTI-STUCK", "Stuck detected! Respawning...", Color3.fromRGB(255, 50, 50))
                        local stuckPos = HRP.CFrame; if Hum then Hum.Health = 0 end
                        Player.CharacterAdded:Wait(); local newChar = Player.Character or Player.CharacterAdded:Wait()
                        local newHRP = newChar:WaitForChild("HumanoidRootPart", 10); task.wait(1)
                        if newHRP then newHRP.CFrame = stuckPos end; task.wait(0.5); ForceEquipRod()
                        Notify("ANTI-STUCK", "Recovered!", Color3.fromRGB(0, 255, 100))
                        LastFishCaughtTime = tick(); LastFishCount = currentFish 
                    end
                end
            end)
        else
            local ls = Player:FindFirstChild("leaderstats"); if ls and ls:FindFirstChild("Caught") then LastFishCount = ls.Caught.Value end
            LastFishCaughtTime = tick()
        end
    end
end)

-- Auto Event
BtnEvent.MouseButton1Click:Connect(function()
    States.AutoEvent = not States.AutoEvent
    BtnEvent.Text = "Auto Event: " .. (States.AutoEvent and "ON" or "OFF")
    ToggleVisual(BtnEvent, States.AutoEvent)
    if not States.AutoEvent then IsInEvent = false; SetWoW(false) end
end)

task.spawn(function()
    while true do
        task.wait(3)
        if States.AutoEvent then
            pcall(function()
                if not HRP or not HRP.Parent then return end
                local Props = Services.Workspace:FindFirstChild("Props")
                local FoundEvent = nil
                if Props then
                    local children = Props:GetChildren()
                    for i = 1, math.min(#children, 50) do 
                        local v = children[i]
                        if v:IsA("Model") or v:IsA("BasePart") then FoundEvent = v; break end
                    end
                end
                if FoundEvent then
                    if not IsInEvent then
                        EventStartCFrame = HRP.CFrame; IsInEvent = true
                        Notify("AUTO EVENT", "Event Found!", Color3.fromRGB(255, 255, 0))
                    end
                    local targetPos = FoundEvent:GetPivot().Position
                    if (HRP.Position - Vector3.new(targetPos.X, 3, targetPos.Z)).Magnitude > 10 then
                        HRP.CFrame = CFrame.new(Vector3.new(targetPos.X, 3, targetPos.Z))
                    end
                    if not States.WoW then SetWoW(true) end
                else
                    if IsInEvent then
                        IsInEvent = false; Notify("AUTO EVENT", "Event Finished.", Color3.fromRGB(0, 255, 100))
                        if EventStartCFrame and HRP then HRP.CFrame = EventStartCFrame; EventStartCFrame = nil end
                        if States.WoW then SetWoW(false) end
                    end
                end
            end)
        end
    end
end)

-- Auto Equip Loop
task.spawn(function() while true do task.wait(2); if States.AutoEquip then ForceEquipRod() end end end)

-- Stats Loop
task.spawn(function()
    while true do
        task.wait(1)
        if States.Panel then
            pcall(function()
                local ls = Player:FindFirstChild("leaderstats")
                local caught = ls and ls:FindFirstChild("Caught") and ls.Caught.Value or 0
                local bagText = "0/?"
                if Player:FindFirstChild("Backpack") then bagText = tostring(#Player.Backpack:GetChildren()) end
                LblFishVal.Text = "FISH: " .. caught
                LblInvVal.Text = "BAG: " .. bagText
            end)
        end
    end
end)

-- Init
task.delay(1, function()
    Main.Visible = true
    FloatHUD.Visible = States.Panel 
end)

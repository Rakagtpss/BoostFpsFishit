--[[ 
    SERAPHIN HELPER - RECODED v3.0 (Stable Version)
    Optimized by: Gemini AI
    Changes:
    - Added Garbage Collection for old threads (Prevents double execution lag)
    - Secured Remote Events with pcall
    - Optimized Clean Memory loop to prevent crashing
    - Fixed character respawn logic
]]

-- [1] SYSTEM CLEANUP (Mencegah Script Bertumpuk)
-- Kita cek apakah script sudah pernah jalan. Jika ya, bersihkan dulu.
if _G.SeraphinConnections then
    for _, conn in pairs(_G.SeraphinConnections) do
        if conn then conn:Disconnect() end
    end
end
_G.SeraphinConnections = {} -- Reset tabel koneksi

local CoreGui = game:GetService("CoreGui")
if CoreGui:FindFirstChild("SeraphinHelper") then
    CoreGui.SeraphinHelper:Destroy()
end

-- [2] SERVICES & VARIABLES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local TeleportService = game:GetService("TeleportService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterGui = game:GetService("StarterGui")
local VirtualUser = game:GetService("VirtualUser")

local Player = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Notifikasi Awal
pcall(function()
    StarterGui:SetCore("SendNotification", {
        Title = "Seraphin Helper",
        Text = "Memuat Versi Stabil v3.0...",
        Duration = 2,
    })
end)

-- [3] UI THEME CONFIGURATION
local UI_THEME = {
    Width = 280, 
    Height = 230,
    Color = Color3.fromRGB(12, 12, 14), 
    Transparency = 0.15, -- Sedikit lebih gelap agar tulisan jelas
    HeaderColor = Color3.fromRGB(18, 18, 22),
    Accent = Color3.fromRGB(0, 255, 170),
    TabOff = Color3.fromRGB(120, 120, 130),
    TabOn = Color3.fromRGB(0, 255, 170),
    TextColor = Color3.fromRGB(240, 240, 240),
    SubTextColor = Color3.fromRGB(160, 160, 170),
    Font = Enum.Font.GothamBold,
    BtnFont = Enum.Font.GothamMedium 
}

-- [4] UI CREATION
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SeraphinHelper"
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- >> MAIN FRAME
local Main = Instance.new("Frame", ScreenGui)
Main.Name = "Main"
Main.Size = UDim2.new(0, UI_THEME.Width, 0, UI_THEME.Height)
Main.Position = UDim2.new(0.5, -UI_THEME.Width/2, 0.4, 0)
Main.BackgroundColor3 = UI_THEME.Color
Main.BackgroundTransparency = UI_THEME.Transparency
Main.Active = true
Main.Draggable = true -- Note: Draggable is deprecated but works for simple GUIs
Main.ClipsDescendants = true 
Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 8)

-- Stroke (Garis Pinggir)
local MainStroke = Instance.new("UIStroke", Main)
MainStroke.Color = UI_THEME.Accent
MainStroke.Thickness = 1.2
MainStroke.Transparency = 0.4

-- Header
local Header = Instance.new("Frame", Main)
Header.Name = "Header"
Header.Size = UDim2.new(1, 0, 0, 32) 
Header.BackgroundColor3 = UI_THEME.HeaderColor
Header.BackgroundTransparency = 0.2
Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 8)

local HeaderFiller = Instance.new("Frame", Header) -- Penutup sudut bawah header
HeaderFiller.Size = UDim2.new(1, 0, 0, 10)
HeaderFiller.Position = UDim2.new(0, 0, 1, -10)
HeaderFiller.BackgroundColor3 = UI_THEME.HeaderColor
HeaderFiller.BackgroundTransparency = 0.2
HeaderFiller.BorderSizePixel = 0

local Title = Instance.new("TextLabel", Header)
Title.Size = UDim2.new(1, -60, 1, 0) 
Title.Position = UDim2.new(0, 12, 0, 0)
Title.Text = "SERAPHIN <font color=\"rgb(0,255,170)\">HELPER v3</font>"
Title.RichText = true
Title.TextColor3 = Color3.new(1,1,1)
Title.Font = UI_THEME.Font
Title.TextSize = 13
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left 

-- Minimize Button
local HideBtn = Instance.new("TextButton", Header)
HideBtn.Size = UDim2.new(0, 50, 0, 20) 
HideBtn.Position = UDim2.new(1, -55, 0.5, -10)
HideBtn.Text = "Hide" 
HideBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
HideBtn.BackgroundTransparency = 0.5
HideBtn.TextColor3 = UI_THEME.Accent
HideBtn.Font = Enum.Font.GothamBold
HideBtn.TextSize = 10
HideBtn.AutoButtonColor = true
Instance.new("UICorner", HideBtn).CornerRadius = UDim.new(0, 4)

-- >> FLOATING INFO PANEL
local FloatHUD = Instance.new("Frame", ScreenGui)
FloatHUD.Name = "FloatingStats"
FloatHUD.Size = UDim2.new(0, 140, 0, 125) 
FloatHUD.Position = UDim2.new(0.85, 0, 0.4, 0)
FloatHUD.BackgroundColor3 = UI_THEME.Color
FloatHUD.BackgroundTransparency = 0.4
FloatHUD.Visible = true
FloatHUD.Active = true
FloatHUD.Draggable = true 
Instance.new("UICorner", FloatHUD).CornerRadius = UDim.new(0, 8)
Instance.new("UIStroke", FloatHUD).Color = UI_THEME.Accent
FloatHUD.UIStroke.Transparency = 0.6

local FloatList = Instance.new("UIListLayout", FloatHUD)
FloatList.FillDirection = Enum.FillDirection.Vertical
FloatList.Padding = UDim.new(0, 5)
FloatList.HorizontalAlignment = Enum.HorizontalAlignment.Center
FloatList.SortOrder = Enum.SortOrder.LayoutOrder

local FloatPad = Instance.new("UIPadding", FloatHUD)
FloatPad.PaddingTop = UDim.new(0, 10)

-- Helper Function: Create Text Block in HUD
local function CreateHUDBlock(text, default, order)
    local F = Instance.new("Frame", FloatHUD)
    F.BackgroundTransparency = 1
    F.Size = UDim2.new(0.9, 0, 0, 35)
    F.LayoutOrder = order
    
    local T = Instance.new("TextLabel", F)
    T.Size = UDim2.new(1, 0, 0, 12)
    T.BackgroundTransparency = 1
    T.Text = string.upper(text)
    T.TextColor3 = UI_THEME.SubTextColor
    T.Font = Enum.Font.GothamBold
    T.TextSize = 9
    
    local V = Instance.new("TextLabel", F)
    V.Size = UDim2.new(1, 0, 0, 20)
    V.Position = UDim2.new(0, 0, 0, 12)
    V.BackgroundTransparency = 1
    V.Text = default
    V.TextColor3 = UI_THEME.TextColor
    V.Font = Enum.Font.GothamBlack
    V.TextSize = 16
    return V
end

local LblHUDTitle = Instance.new("TextLabel", FloatHUD)
LblHUDTitle.Text = "STATS INFO"
LblHUDTitle.Font = Enum.Font.GothamBlack
LblHUDTitle.TextColor3 = UI_THEME.Accent
LblHUDTitle.TextSize = 12
LblHUDTitle.Size = UDim2.new(1,0,0,15)
LblHUDTitle.BackgroundTransparency = 1
LblHUDTitle.LayoutOrder = 1

local LblFish = CreateHUDBlock("FISH CAUGHT", "...", 2)
local LblBag  = CreateHUDBlock("BACKPACK", "...", 3)

-- >> TAB SYSTEM
local TabHolder = Instance.new("Frame", Main)
TabHolder.Size = UDim2.new(1, 0, 0, 28)
TabHolder.Position = UDim2.new(0, 0, 0, 32)
TabHolder.BackgroundTransparency = 1

local PageContainer = Instance.new("Frame", Main)
PageContainer.Size = UDim2.new(1, -16, 1, -70)
PageContainer.Position = UDim2.new(0, 8, 0, 64)
PageContainer.BackgroundTransparency = 1

local function CreateTab(name, pos, active)
    local Btn = Instance.new("TextButton", TabHolder)
    Btn.Size = UDim2.new(0.5, 0, 1, 0)
    Btn.Position = pos
    Btn.BackgroundTransparency = 1
    Btn.Text = name
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 11
    Btn.TextColor3 = active and UI_THEME.TabOn or UI_THEME.TabOff
    return Btn
end

local Tab1 = CreateTab("MAIN", UDim2.new(0,0,0,0), true)
local Tab2 = CreateTab("MISC", UDim2.new(0.5,0,0,0), false)

local Page1 = Instance.new("Frame", PageContainer)
Page1.Size = UDim2.new(1, 0, 1, 0)
Page1.BackgroundTransparency = 1
Page1.Visible = true
local Grid1 = Instance.new("UIGridLayout", Page1)
Grid1.CellSize = UDim2.new(0, 128, 0, 28)
Grid1.CellPadding = UDim2.new(0, 8, 0, 6)
Grid1.HorizontalAlignment = Enum.HorizontalAlignment.Center

local Page2 = Instance.new("Frame", PageContainer)
Page2.Size = UDim2.new(1, 0, 1, 0)
Page2.BackgroundTransparency = 1
Page2.Visible = false
local Grid2 = Instance.new("UIGridLayout", Page2)
Grid2.CellSize = UDim2.new(0, 128, 0, 28)
Grid2.CellPadding = UDim2.new(0, 8, 0, 6)
Grid2.HorizontalAlignment = Enum.HorizontalAlignment.Center

-- Tab Logic
Tab1.MouseButton1Click:Connect(function()
    Page1.Visible = true; Page2.Visible = false
    Tab1.TextColor3 = UI_THEME.TabOn; Tab2.TextColor3 = UI_THEME.TabOff
end)
Tab2.MouseButton1Click:Connect(function()
    Page1.Visible = false; Page2.Visible = true
    Tab1.TextColor3 = UI_THEME.TabOff; Tab2.TextColor3 = UI_THEME.TabOn
end)

-- Helper: Create Menu Button
local function CreateBtn(parent, text)
    local B = Instance.new("TextButton", parent)
    B.Text = text
    B.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
    B.BackgroundTransparency = 0.5
    B.TextColor3 = Color3.fromRGB(200, 200, 200)
    B.Font = UI_THEME.BtnFont
    B.TextSize = 10
    B.AutoButtonColor = true
    Instance.new("UICorner", B).CornerRadius = UDim.new(0, 4)
    Instance.new("UIStroke", B).Color = Color3.fromRGB(60, 60, 70)
    B.UIStroke.Transparency = 0.5
    return B
end

local function ToggleStyle(btn, state)
    if state then
        btn.BackgroundColor3 = UI_THEME.Accent
        btn.TextColor3 = Color3.fromRGB(10, 10, 12)
        btn.BackgroundTransparency = 0.2
        btn.UIStroke.Transparency = 1
        btn.Font = Enum.Font.GothamBold
    else
        btn.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
        btn.TextColor3 = Color3.fromRGB(200, 200, 200)
        btn.BackgroundTransparency = 0.5
        btn.UIStroke.Transparency = 0.5
        btn.Font = UI_THEME.BtnFont
    end
end

-- [5] FEATURES & BUTTONS
local Toggles = {
    AutoEquip = false,
    Freeze = false,
    WaterWalk = false,
    NoClip = false,
    Boost = false,
    NoRender = false,
    Panel = true
}

-- Buttons Page 1
local B_Equip  = CreateBtn(Page1, "Auto Equip: OFF")
local B_Freeze = CreateBtn(Page1, "Freeze: OFF")
local B_Walk   = CreateBtn(Page1, "Water Walk: OFF")
local B_Noclip = CreateBtn(Page1, "No Clip: OFF")
local B_Boost  = CreateBtn(Page1, "Boost FPS: OFF")
local B_Render = CreateBtn(Page1, "3D Render: ON")
local B_FPS    = CreateBtn(Page1, "FPS Cap: Unli")

-- Buttons Page 2
local B_Save   = CreateBtn(Page2, "Save Pos")
local B_Load   = CreateBtn(Page2, "Load Pos")
local B_Rejoin = CreateBtn(Page2, "Rejoin Server")
local B_Panel  = CreateBtn(Page2, "Panel Info: ON")
local B_Clean  = CreateBtn(Page2, "Clean Memory")

ToggleStyle(B_Panel, true) -- Default ON

-- >> LOGIC IMPLEMENTATION

-- 1. Anti-AFK (Agar tidak disconnect)
local afkConn = VirtualUser:CaptureController()
if VirtualUser then
    VirtualUser:ClickButton2(Vector2.new())
end

-- 2. FPS Counter
local fps = 0
local fpsConn = RunService.RenderStepped:Connect(function(dt)
    fps = math.floor(1 / dt)
    if not Title then return end
    Title.Text = "SERAPHIN <font color=\"rgb(0,255,170)\">HELPER</font>  |  FPS: <b>" .. fps .. "</b>"
end)
table.insert(_G.SeraphinConnections, fpsConn)

-- 3. Auto Equip Logic
task.spawn(function()
    while task.wait(1.5) do
        if not ScreenGui.Parent then break end -- Stop loop if UI destroyed
        if Toggles.AutoEquip and Player.Character then
            pcall(function()
                local char = Player.Character
                if not char:FindFirstChildWhichIsA("Tool") then
                    -- Safety Check for Remote
                    local RemoteFolder = ReplicatedStorage:FindFirstChild("Packages")
                    if RemoteFolder and RemoteFolder:FindFirstChild("_Index") then
                        local net = RemoteFolder._Index:FindFirstChild("sleitnick_net@0.2.0")
                        if net then
                            net.net["RE/EquipToolFromHotbar"]:FireServer(1)
                        end
                    end
                end
            end)
        end
    end
end)

-- 4. Stats Updater (Panel)
task.spawn(function()
    while task.wait(1) do
        if not ScreenGui.Parent then break end
        if Toggles.Panel then
            pcall(function()
                -- Fish
                local ls = Player:FindFirstChild("leaderstats")
                if ls and ls:FindFirstChild("Caught") then
                    LblFish.Text = tostring(ls.Caught.Value)
                else
                    LblFish.Text = "N/A"
                end
                
                -- Backpack
                local bag = Player:FindFirstChild("PlayerGui")
                if bag and bag:FindFirstChild("Backpack") then
                   -- Coba cari textlabel yang punya format "/"
                   local found = false
                   for _,v in pairs(bag.Backpack:GetDescendants()) do
                       if v:IsA("TextLabel") and string.find(v.Text, "/") then
                           LblBag.Text = v.Text
                           found = true
                           break
                       end
                   end
                   if not found then LblBag.Text = #Player.Backpack:GetChildren() end
                else
                    LblBag.Text = #Player.Backpack:GetChildren()
                end
            end)
        end
    end
end)

-- >> BUTTON EVENTS

-- Toggle Minimize
local isMin = false
HideBtn.MouseButton1Click:Connect(function()
    isMin = not isMin
    if isMin then
        PageContainer.Visible = false
        TabHolder.Visible = false
        Main:TweenSize(UDim2.new(0, UI_THEME.Width, 0, 32), "Out", "Quad", 0.3, true)
        HideBtn.Text = "Show"
    else
        Main:TweenSize(UDim2.new(0, UI_THEME.Width, 0, UI_THEME.Height), "Out", "Back", 0.3, true)
        HideBtn.Text = "Hide"
        task.delay(0.25, function()
            PageContainer.Visible = true
            TabHolder.Visible = true
        end)
    end
end)

B_Equip.MouseButton1Click:Connect(function()
    Toggles.AutoEquip = not Toggles.AutoEquip
    B_Equip.Text = "Auto Equip: "..(Toggles.AutoEquip and "ON" or "OFF")
    ToggleStyle(B_Equip, Toggles.AutoEquip)
end)

B_Freeze.MouseButton1Click:Connect(function()
    Toggles.Freeze = not Toggles.Freeze
    local root = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
    if root then root.Anchored = Toggles.Freeze end
    B_Freeze.Text = "Freeze: "..(Toggles.Freeze and "ON" or "OFF")
    ToggleStyle(B_Freeze, Toggles.Freeze)
end)

B_Walk.MouseButton1Click:Connect(function()
    Toggles.WaterWalk = not Toggles.WaterWalk
    B_Walk.Text = "Water Walk: "..(Toggles.WaterWalk and "ON" or "OFF")
    ToggleStyle(B_Walk, Toggles.WaterWalk)
    
    if Toggles.WaterWalk then
        -- Apply Float
        local root = Player.Character:WaitForChild("HumanoidRootPart")
        local bv = Instance.new("BodyVelocity", root)
        bv.Name = "SeraphinFloat"
        bv.MaxForce = Vector3.new(0, 100000, 0)
        bv.Velocity = Vector3.zero
        
        -- Keep Height Loop
        local wwConn = RunService.Heartbeat:Connect(function()
             if not Toggles.WaterWalk then return end
             local hrp = Player.Character and Player.Character:FindFirstChild("HumanoidRootPart")
             if hrp then
                local vel = hrp.AssemblyLinearVelocity
                hrp.AssemblyLinearVelocity = Vector3.new(vel.X, 0, vel.Z)
             end
        end)
        table.insert(_G.SeraphinConnections, wwConn)
    else
        -- Remove Float
        if Player.Character then
            for _,v in pairs(Player.Character:GetDescendants()) do
                if v.Name == "SeraphinFloat" then v:Destroy() end
            end
        end
    end
end)

B_Noclip.MouseButton1Click:Connect(function()
    Toggles.NoClip = not Toggles.NoClip
    B_Noclip.Text = "No Clip: "..(Toggles.NoClip and "ON" or "OFF")
    ToggleStyle(B_Noclip, Toggles.NoClip)
    
    local ncConn = RunService.Stepped:Connect(function()
        if Toggles.NoClip and Player.Character then
            for _,v in pairs(Player.Character:GetDescendants()) do
                if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
            end
        end
    end)
    table.insert(_G.SeraphinConnections, ncConn)
end)

B_Boost.MouseButton1Click:Connect(function()
    Toggles.Boost = not Toggles.Boost
    B_Boost.Text = "Boost FPS: "..(Toggles.Boost and "ON" or "OFF")
    ToggleStyle(B_Boost, Toggles.Boost)
    
    Lighting.GlobalShadows = not Toggles.Boost
    if Toggles.Boost then
        Lighting.FogEnd = 9e9
    end
end)

B_Render.MouseButton1Click:Connect(function()
    Toggles.NoRender = not Toggles.NoRender
    RunService:Set3dRenderingEnabled(not Toggles.NoRender)
    B_Render.Text = "3D Render: "..(Toggles.NoRender and "OFF" or "ON")
    ToggleStyle(B_Render, Toggles.NoRender)
end)

B_FPS.MouseButton1Click:Connect(function()
    local caps = {30, 60, 144, 9999}
    _G.fpsIndex = ((_G.fpsIndex or #caps) % #caps) + 1
    local target = caps[_G.fpsIndex]
    
    pcall(function() setfpscap(target) end)
    B_FPS.Text = (target > 1000) and "FPS Cap: Max" or "FPS Cap: "..target
end)

-- Page 2 Buttons
local SavedPos = nil

B_Save.MouseButton1Click:Connect(function()
    if Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
        SavedPos = Player.Character.HumanoidRootPart.CFrame
        B_Save.Text = "SAVED!"
        task.wait(1)
        B_Save.Text = "Save Pos"
    end
end)

B_Load.MouseButton1Click:Connect(function()
    if SavedPos and Player.Character and Player.Character:FindFirstChild("HumanoidRootPart") then
        Player.Character.HumanoidRootPart.CFrame = SavedPos
    end
end)

B_Rejoin.MouseButton1Click:Connect(function()
    TeleportService:Teleport(game.PlaceId, Player)
end)

B_Panel.MouseButton1Click:Connect(function()
    Toggles.Panel = not Toggles.Panel
    FloatHUD.Visible = Toggles.Panel
    B_Panel.Text = "Panel Info: "..(Toggles.Panel and "ON" or "OFF")
    ToggleStyle(B_Panel, Toggles.Panel)
end)

-- [IMPROVED] CLEAN MEMORY
B_Clean.MouseButton1Click:Connect(function()
    if B_Clean.Text == "Cleaning..." then return end -- Prevent spam
    B_Clean.Text = "Cleaning..."
    ToggleStyle(B_Clean, true)
    
    task.spawn(function()
        local count = 0
        -- 1. Bersihkan Environment
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        
        -- 2. Bersihkan Objects (Dengan Jeda agar tidak crash)
        local toClean = {}
        for _, v in pairs(game:GetDescendants()) do
            if v:IsA("Decal") or v:IsA("Texture") or v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Explosion") then
                table.insert(toClean, v)
            elseif v:IsA("MeshPart") then
                v.TextureID = ""
            end
        end
        
        -- Hapus perlahan
        for i, v in ipairs(toClean) do
            pcall(function() v:Destroy() end)
            if i % 200 == 0 then task.wait() end -- Istirahat setiap 200 item
        end
        
        -- 3. Garbage Collect (Jika Executor support)
        pcall(function() 
            if setreadonly then setreadonly(getrawmetatable(game), false) end
            collectgarbage("collect") 
        end)
        
        B_Clean.Text = "DONE"
        task.wait(1)
        B_Clean.Text = "Clean Memory"
        ToggleStyle(B_Clean, false)
    end)
end)


local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local TweenService = game:GetService("TweenService")

local Player = Players.LocalPlayer

-- // --- CONFIGURATION ---
local UI_WIDTH = 300 
local UI_HEIGHT = 280
local THEME = {
    Background = Color3.fromRGB(20, 20, 25),
    Header = Color3.fromRGB(30, 30, 35),
    Button = Color3.fromRGB(40, 40, 45),
    Accent = Color3.fromRGB(0, 255, 170), -- Seraphin Green
    Red = Color3.fromRGB(255, 80, 80),
    Text = Color3.fromRGB(230, 230, 230)
}

-- // State
local AutoTotemActive = false
local SelectedTotemName = "" 

-- // Cleanup
if CoreGui:FindFirstChild("SeraphinV8") then CoreGui.SeraphinV8:Destroy() end

-- // --- UI CREATION ---
local Gui = Instance.new("ScreenGui", CoreGui)
Gui.Name = "SeraphinV8"
Gui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame", Gui)
MainFrame.Size = UDim2.new(0, UI_WIDTH, 0, UI_HEIGHT)
MainFrame.Position = UDim2.new(0.5, -UI_WIDTH/2, 0.3, 0)
MainFrame.BackgroundColor3 = THEME.Background
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 8)

-- Header
local Header = Instance.new("Frame", MainFrame)
Header.Size = UDim2.new(1, 0, 0, 40)
Header.BackgroundColor3 = THEME.Header
Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 8)

local Title = Instance.new("TextLabel", Header)
Title.Size = UDim2.new(0.8, 0, 1, 0)
Title.Position = UDim2.new(0.05, 0, 0, 0)
Title.Text = "SERAPHIN <b>v8 (FIX)</b>"
Title.RichText = true
Title.TextColor3 = THEME.Text
Title.Font = Enum.Font.GothamBold
Title.TextSize = 14
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left

local MinBtn = Instance.new("TextButton", Header)
MinBtn.Size = UDim2.new(0, 25, 0, 25)
MinBtn.Position = UDim2.new(1, -30, 0.5, -12.5)
MinBtn.Text = "X"
MinBtn.BackgroundColor3 = THEME.Red
MinBtn.TextColor3 = Color3.new(1,1,1)
Instance.new("UICorner", MinBtn).CornerRadius = UDim.new(0, 6)

-- // --- CONTAINER ---
local Container = Instance.new("Frame", MainFrame)
Container.Size = UDim2.new(1, -20, 1, -50)
Container.Position = UDim2.new(0, 10, 0, 45)
Container.BackgroundTransparency = 1

local UIList = Instance.new("UIListLayout", Container)
UIList.Padding = UDim.new(0, 6)
UIList.SortOrder = Enum.SortOrder.LayoutOrder

-- 1. INPUT MANUAL (Jaga-jaga)
local InputBox = Instance.new("TextBox", Container)
InputBox.Size = UDim2.new(1, 0, 0, 30)
InputBox.PlaceholderText = "Click Item Below or Type Name..."
InputBox.Text = ""
InputBox.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
InputBox.TextColor3 = THEME.Accent
InputBox.Font = Enum.Font.GothamBold
InputBox.TextSize = 11
InputBox.LayoutOrder = 1
Instance.new("UICorner", InputBox).CornerRadius = UDim.new(0, 6)

InputBox:GetPropertyChangedSignal("Text"):Connect(function()
    SelectedTotemName = InputBox.Text
end)

-- 2. LIST SCROLL
local ScrollList = Instance.new("ScrollingFrame", Container)
ScrollList.Size = UDim2.new(1, 0, 0, 90)
ScrollList.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
ScrollList.ScrollBarThickness = 3
ScrollList.LayoutOrder = 2
ScrollList.AutomaticCanvasSize = Enum.AutomaticSize.Y
Instance.new("UICorner", ScrollList).CornerRadius = UDim.new(0, 6)
local ScrollLayout = Instance.new("UIListLayout", ScrollList)
ScrollLayout.Padding = UDim.new(0, 2)

-- 3. TOMBOL EKSEKUSI
local SpawnBtn = Instance.new("TextButton", Container)
SpawnBtn.Size = UDim2.new(1, 0, 0, 35)
SpawnBtn.Text = "SPAWN TOTEM NOW"
SpawnBtn.BackgroundColor3 = THEME.Accent
SpawnBtn.TextColor3 = Color3.fromRGB(20, 20, 25)
SpawnBtn.Font = Enum.Font.GothamBold
SpawnBtn.TextSize = 12
SpawnBtn.LayoutOrder = 3
Instance.new("UICorner", SpawnBtn).CornerRadius = UDim.new(0, 6)

local AutoBtn = Instance.new("TextButton", Container)
AutoBtn.Size = UDim2.new(1, 0, 0, 25)
AutoBtn.Text = "AUTO LOOP (60m): OFF"
AutoBtn.BackgroundColor3 = THEME.Button
AutoBtn.TextColor3 = THEME.Red
AutoBtn.Font = Enum.Font.GothamBold
AutoBtn.TextSize = 10
AutoBtn.LayoutOrder = 4
Instance.new("UICorner", AutoBtn).CornerRadius = UDim.new(0, 6)

local StatusLbl = Instance.new("TextLabel", Container)
StatusLbl.Size = UDim2.new(1, 0, 0, 20)
StatusLbl.Text = "Ready."
StatusLbl.TextColor3 = Color3.fromRGB(150, 150, 150)
StatusLbl.BackgroundTransparency = 1
StatusLbl.Font = Enum.Font.Code
StatusLbl.TextSize = 10
StatusLbl.LayoutOrder = 5

-- // --- FUNGSI LOGIC ---

local function ScanTotems()
    -- Scan backpack pemain (prioritas)
    local itemsFound = {}
    local Backpack = Player.Backpack
    
    -- Scan Collection (sebagai referensi nama)
    local Success, Folder = pcall(function()
        return game:GetService("ReplicatedStorage").Modules.ModelDownloader.Collection.Totems
    end)

    -- Bersihkan list
    for _, v in pairs(ScrollList:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end

    -- Helper untuk buat tombol
    local function AddBtn(name, isOwned)
        local btn = Instance.new("TextButton", ScrollList)
        btn.Size = UDim2.new(1, 0, 0, 25)
        btn.Text = isOwned and " [OWNED] " .. name or " " .. name
        btn.BackgroundColor3 = isOwned and Color3.fromRGB(50, 60, 50) or Color3.fromRGB(35, 35, 40)
        btn.TextColor3 = isOwned and THEME.Accent or Color3.fromRGB(150, 150, 150)
        btn.Font = Enum.Font.Gotham
        btn.TextSize = 10
        
        btn.MouseButton1Click:Connect(function()
            SelectedTotemName = name
            InputBox.Text = name
            
            -- Feedback Visual
            for _, b in pairs(ScrollList:GetChildren()) do
                if b:IsA("TextButton") then b.BackgroundColor3 = Color3.fromRGB(35, 35, 40) end
            end
            btn.BackgroundColor3 = THEME.Accent
            StatusLbl.Text = "Selected: " .. name
        end)
    end

    -- Tambahkan item dari Collection ke list
    if Success and Folder then
        for _, item in pairs(Folder:GetChildren()) do
            -- Cek apakah player punya item ini di backpack
            local owned = Backpack:FindFirstChild(item.Name) ~= nil
            if Player.Character then
                if Player.Character:FindFirstChild(item.Name) then owned = true end
            end
            
            AddBtn(item.Name, owned)
        end
    else
        StatusLbl.Text = "Scan Error: Path Not Found"
    end
end

local function ActivateTotem()
    if SelectedTotemName == "" then 
        StatusLbl.Text = "ERROR: Pilih Item Dulu!"
        return 
    end
    
    local Character = Player.Character
    if not Character then return end
    local Humanoid = Character:FindFirstChild("Humanoid")
    local Backpack = Player.Backpack
    
    -- 1. CARI & EQUIP ITEM
    local Tool = Character:FindFirstChild(SelectedTotemName) or Backpack:FindFirstChild(SelectedTotemName)
    
    if Tool then
        if Tool.Parent == Backpack then
            Humanoid:EquipTool(Tool)
            StatusLbl.Text = "Equipping " .. SelectedTotemName .. "..."
            task.wait(0.3) -- Tunggu equip selesai
        end
    else
        StatusLbl.Text = "ERROR: Item tidak ada di Tas!"
        return -- Berhenti jika item tidak ada
    end
    
    -- 2. FIRE REMOTE (METODE 1: ARGUMEN 'Totems')
    -- Ini sesuai log aslimu: [1] = "Totems"
    local args = {
        [1] = "Totems" 
    }
    
    local Replicated = game:GetService("ReplicatedStorage")
    local Net = Replicated.Packages._Index:FindFirstChild("sleitnick_net@0.2.0")
    
    if Net and Net.net then
        local Remote = Net.net:FindFirstChild("RE/SpawnTotem")
        if Remote then
            Remote:FireServer(unpack(args))
            print("Fired SpawnTotem with 'Totems'")
        end
    end
    
    -- 3. CADANGAN: SIMULASI KLIK (VIRTUAL INPUT)
    -- Jika remote gagal, kita paksa klik kiri karena item sudah dipegang
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
    task.wait(0.1)
    VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
    
    StatusLbl.Text = "Spawn Attempted!"
    
    -- 4. Unequip (Opsional, agar rapi)
    task.wait(1)
    -- Humanoid:UnequipTools() -- Aktifkan jika ingin otomatis lepas
end

-- // --- LOGIC TOMBOL ---

SpawnBtn.MouseButton1Click:Connect(function()
    ActivateTotem()
end)

AutoBtn.MouseButton1Click:Connect(function()
    AutoTotemActive = not AutoTotemActive
    if AutoTotemActive then
        AutoBtn.Text = "AUTO LOOP (60m): ON"
        AutoBtn.TextColor3 = THEME.Accent
        
        task.spawn(function()
            while AutoTotemActive do
                ActivateTotem()
                
                -- Countdown 3600 detik
                for i = 3600, 1, -1 do
                    if not AutoTotemActive then break end
                    StatusLbl.Text = "Next: " .. i .. "s"
                    task.wait(1)
                end
            end
        end)
    else
        AutoBtn.Text = "AUTO LOOP (60m): OFF"
        AutoBtn.TextColor3 = THEME.Red
        StatusLbl.Text = "Auto Stopped."
    end
end)

MinBtn.MouseButton1Click:Connect(function()
    Gui:Destroy()
end)

-- Jalankan Scan
ScanTotems()

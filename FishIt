local function SafeLoad()
    if not game:IsLoaded() then game.Loaded:Wait() end
    
    -- [ SERVICES ]
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local CoreGui = game:GetService("CoreGui")
    local Lighting = game:GetService("Lighting")
    local TeleportService = game:GetService("TeleportService")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local StarterGui = game:GetService("StarterGui")

    local Player = Players.LocalPlayer

    -- [1] SAFE UI PARENTING (SOLUSI JIKA UI TIDAK MUNCUL)
    local UI_Parent = CoreGui
    local success, err = pcall(function()
        local test = Instance.new("ScreenGui", CoreGui)
        test:Destroy()
    end)

    if not success then
        UI_Parent = Player:WaitForChild("PlayerGui")
        -- warn("CoreGui tidak aksesibel, menggunakan PlayerGui.")
    end

    -- [2] CHARACTER HANDLING (ANTI STUCK)
    local Char = Player.Character or Player.CharacterAdded:Wait()
    local HRP = Char:FindFirstChild("HumanoidRootPart")

    Player.CharacterAdded:Connect(function(newChar)
        Char = newChar
        HRP = newChar:WaitForChild("HumanoidRootPart", 10)
    end)

    -- [3] DATA EVENT (SAFE LOAD)
    local AvailableEvents = {"Megalodon", "Shark", "Treasure", "Merchant", "Kraken", "Rumia", "Seabeast"} 
    local EventsFolder = ReplicatedStorage:FindFirstChild("Events")

    if EventsFolder then
        local names = {}
        for _, evt in pairs(EventsFolder:GetChildren()) do
            table.insert(names, evt.Name)
        end
        if #names > 0 then AvailableEvents = names end
    end

    -- [4] UI CONFIGURATION
    local UI_THEME = {
        Width = 260,
        Height = 310,
        Color = Color3.fromRGB(14, 14, 18), 
        HeaderColor = Color3.fromRGB(20, 20, 25),
        Accent = Color3.fromRGB(0, 255, 170),
        TextColor = Color3.fromRGB(255, 255, 255),
        Font = Enum.Font.GothamBold,
        BtnFont = Enum.Font.GothamMedium 
    }

    -- Bersihkan UI Lama
    if UI_Parent:FindFirstChild("SeraphinHelper") then UI_Parent.SeraphinHelper:Destroy() end

    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "SeraphinHelper"
    ScreenGui.Parent = UI_Parent
    ScreenGui.ResetOnSpawn = false
    ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- ====================================================
    -- FLOATING PANEL (MINI HUD)
    -- ====================================================
    local FloatHUD = Instance.new("Frame", ScreenGui)
    FloatHUD.Name = "FloatingStats"
    FloatHUD.Size = UDim2.new(0, 140, 0, 125) 
    FloatHUD.Position = UDim2.new(0.8, 0, 0.3, 0)
    FloatHUD.BackgroundColor3 = Color3.fromRGB(12, 12, 15)
    FloatHUD.BackgroundTransparency = 0.2
    FloatHUD.Active = true
    FloatHUD.Draggable = true 

    Instance.new("UICorner", FloatHUD).CornerRadius = UDim.new(0, 8)
    local HudStroke = Instance.new("UIStroke", FloatHUD)
    HudStroke.Color = UI_THEME.Accent
    HudStroke.Thickness = 1.5
    HudStroke.Transparency = 0.4

    local ListLayout = Instance.new("UIListLayout", FloatHUD)
    ListLayout.FillDirection = Enum.FillDirection.Vertical
    ListLayout.Padding = UDim.new(0, 5) 
    ListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    ListLayout.SortOrder = Enum.SortOrder.LayoutOrder 

    local Padding = Instance.new("UIPadding", FloatHUD)
    Padding.PaddingTop = UDim.new(0, 10) 

    local TitleInfo = Instance.new("TextLabel", FloatHUD)
    TitleInfo.Size = UDim2.new(1, 0, 0, 15)
    TitleInfo.BackgroundTransparency = 1
    TitleInfo.Text = "INFO PANEL"
    TitleInfo.TextColor3 = UI_THEME.Accent
    TitleInfo.Font = Enum.Font.GothamBlack
    TitleInfo.TextSize = 12

    local function CreateStat(text, val)
        local F = Instance.new("Frame", FloatHUD)
        F.Size = UDim2.new(0.9, 0, 0, 30)
        F.BackgroundTransparency = 1
        
        local T = Instance.new("TextLabel", F)
        T.Size = UDim2.new(1,0,0,10)
        T.Text = text
        T.TextColor3 = Color3.fromRGB(150,150,150)
        T.BackgroundTransparency = 1
        T.Font = Enum.Font.GothamBold
        T.TextSize = 10
        
        local V = Instance.new("TextLabel", F)
        V.Size = UDim2.new(1,0,0,15)
        V.Position = UDim2.new(0,0,0,12)
        V.Text = val
        V.TextColor3 = Color3.fromRGB(255,255,255)
        V.BackgroundTransparency = 1
        V.Font = Enum.Font.GothamBold
        V.TextSize = 14
        return V
    end

    local LblFish = CreateStat("FISH CAUGHT", "...")
    local LblBag  = CreateStat("BACKPACK", "...")

    -- ====================================================
    -- MAIN UI
    -- ====================================================
    local Main = Instance.new("Frame", ScreenGui)
    Main.Name = "MainFrame"
    Main.Size = UDim2.new(0, UI_THEME.Width, 0, UI_THEME.Height)
    Main.Position = UDim2.new(0.5, -130, 0.4, 0)
    Main.BackgroundColor3 = UI_THEME.Color
    Main.Active = true
    Main.Draggable = true
    Main.ClipsDescendants = true
    Instance.new("UICorner", Main).CornerRadius = UDim.new(0, 8)

    local Header = Instance.new("Frame", Main)
    Header.Size = UDim2.new(1, 0, 0, 30)
    Header.BackgroundColor3 = UI_THEME.HeaderColor
    Instance.new("UICorner", Header).CornerRadius = UDim.new(0, 8)

    local Title = Instance.new("TextLabel", Header)
    Title.Size = UDim2.new(1, -50, 1, 0)
    Title.Position = UDim2.new(0, 10, 0, 0)
    Title.Text = "SERAPHIN <font color=\"rgb(0,255,170)\">HELPER</font>"
    Title.RichText = true
    Title.TextColor3 = Color3.white
    Title.BackgroundTransparency = 1
    Title.Font = UI_THEME.Font
    Title.TextSize = 12
    Title.TextXAlignment = Enum.TextXAlignment.Left

    -- Hide Button
    local HideBtn = Instance.new("TextButton", Header)
    HideBtn.Size = UDim2.new(0, 40, 0, 18)
    HideBtn.Position = UDim2.new(1, -45, 0.5, -9)
    HideBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    HideBtn.Text = "Hide"
    HideBtn.TextColor3 = Color3.white
    HideBtn.TextSize = 9
    Instance.new("UICorner", HideBtn).CornerRadius = UDim.new(0, 4)

    -- Container
    local Container = Instance.new("Frame", Main)
    Container.Size = UDim2.new(1, -10, 1, -40)
    Container.Position = UDim2.new(0, 5, 0, 35)
    Container.BackgroundTransparency = 1

    local Grid = Instance.new("UIGridLayout", Container)
    Grid.CellSize = UDim2.new(0, 120, 0, 30)
    Grid.CellPadding = UDim2.new(0, 5, 0, 5)
    Grid.HorizontalAlignment = Enum.HorizontalAlignment.Center

    -- ====================================================
    -- LOGIC & BUTTONS
    -- ====================================================
    local States = {
        Freeze = false, WoW = false, Noclip = false, 
        Boost = false, Panel = true, AutoEvent = false
    }

    local EvtPrimary = AvailableEvents[1]
    local EvtSecondary = AvailableEvents[2] or AvailableEvents[1]
    local Idx1, Idx2 = 1, 2
    if #AvailableEvents < 2 then Idx2 = 1 end

    local function CreateBtn(text, callback)
        local B = Instance.new("TextButton", Container)
        B.Text = text
        B.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
        B.TextColor3 = Color3.fromRGB(200, 200, 200)
        B.TextSize = 10
        B.Font = UI_THEME.BtnFont
        Instance.new("UICorner", B).CornerRadius = UDim.new(0, 4)
        local S = Instance.new("UIStroke", B)
        S.Color = Color3.fromRGB(50,50,50)
        S.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        
        B.MouseButton1Click:Connect(function()
            callback(B)
        end)
        return B
    end

    local function UpdateBtn(btn, status)
        if status then
            btn.BackgroundColor3 = UI_THEME.Accent
            btn.TextColor3 = Color3.black
            btn.UIStroke.Transparency = 1
        else
            btn.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
            btn.TextColor3 = Color3.fromRGB(200, 200, 200)
            btn.UIStroke.Transparency = 0
        end
    end

    -- [BUTTONS]
    local BtnFrz = CreateBtn("Freeze: OFF", function(b)
        States.Freeze = not States.Freeze
        b.Text = "Freeze: "..(States.Freeze and "ON" or "OFF")
        UpdateBtn(b, States.Freeze)
        if HRP then HRP.Anchored = States.Freeze end
    end)

    local BtnWoW = CreateBtn("Water Walk: OFF", function(b)
        States.WoW = not States.WoW
        b.Text = "Water Walk: "..(States.WoW and "ON" or "OFF")
        UpdateBtn(b, States.WoW)
    end)

    local BtnNC = CreateBtn("NoClip: OFF", function(b)
        States.Noclip = not States.Noclip
        b.Text = "NoClip: "..(States.Noclip and "ON" or "OFF")
        UpdateBtn(b, States.Noclip)
    end)

    local BtnEv1 = CreateBtn("1. Utama: "..EvtPrimary, function(b)
        Idx1 = Idx1 + 1
        if Idx1 > #AvailableEvents then Idx1 = 1 end
        EvtPrimary = AvailableEvents[Idx1]
        b.Text = "1. Utama: "..string.sub(EvtPrimary, 1, 9)
    end)

    local BtnEv2 = CreateBtn("2. Cadangan: "..EvtSecondary, function(b)
        Idx2 = Idx2 + 1
        if Idx2 > #AvailableEvents then Idx2 = 1 end
        EvtSecondary = AvailableEvents[Idx2]
        b.Text = "2. Cadangan: "..string.sub(EvtSecondary, 1, 9)
    end)

    local BtnAuto = CreateBtn("Auto TP: OFF", function(b)
        States.AutoEvent = not States.AutoEvent
        b.Text = "Auto TP: "..(States.AutoEvent and "ON" or "OFF")
        UpdateBtn(b, States.AutoEvent)
        if States.AutoEvent then
            StarterGui:SetCore("SendNotification", {Title="Auto TP", Text="Mencari: "..EvtPrimary})
        end
    end)

    local BtnRejoin = CreateBtn("Rejoin", function()
        TeleportService:Teleport(game.PlaceId, Player)
    end)

    local BtnPanel = CreateBtn("Panel Info: ON", function(b)
        States.Panel = not States.Panel
        FloatHUD.Visible = States.Panel
        b.Text = "Panel Info: "..(States.Panel and "ON" or "OFF")
        UpdateBtn(b, States.Panel)
    end)

    UpdateBtn(BtnPanel, true)

    -- ====================================================
    -- LOOPS & LOGIC
    -- ====================================================
    local BodyV = nil

    -- UI Hiding Logic
    local minimized = false
    HideBtn.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            Container.Visible = false
            Main:TweenSize(UDim2.new(0, UI_THEME.Width, 0, 30), "Out", "Quad", 0.3, true)
            HideBtn.Text = "+"
        else
            Main:TweenSize(UDim2.new(0, UI_THEME.Width, 0, UI_THEME.Height), "Out", "Back", 0.3, true)
            HideBtn.Text = "Hide"
            task.delay(0.25, function() if not minimized then Container.Visible = true end end)
        end
    end)

    -- Main Loop
    task.spawn(function()
        while true do
            task.wait(1)
            
            -- Safe Character Refetch
            if not HRP or not HRP.Parent then
                if Player.Character then HRP = Player.Character:FindFirstChild("HumanoidRootPart") end
            end

            -- Water Walk Logic
            if States.WoW and HRP then
                if not BodyV then
                    BodyV = Instance.new("BodyVelocity", HRP)
                    BodyV.MaxForce = Vector3.new(0, 1e5, 0)
                    BodyV.Velocity = Vector3.zero
                end
            elseif BodyV then
                BodyV:Destroy()
                BodyV = nil
            end

            -- Auto Teleport Logic
            if States.AutoEvent and HRP then
                pcall(function()
                    local Target = nil
                    
                    local function FindSafe(name)
                        if not name then return nil end
                        local t = workspace:FindFirstChild(name, true) 
                        if not t then
                            for _,v in pairs(workspace:GetChildren()) do
                                if string.find(v.Name, name) then return v end
                            end
                        end
                        return t
                    end

                    Target = FindSafe(EvtPrimary)
                    if not Target then Target = FindSafe(EvtSecondary) end

                    if Target then
                        local tCF = nil
                        if Target:IsA("Model") then tCF = Target:GetPivot() 
                        elseif Target:IsA("BasePart") then tCF = Target.CFrame end
                        
                        if tCF and (HRP.Position - tCF.Position).Magnitude > 50 then
                            HRP.CFrame = tCF + Vector3.new(0, 15, 0)
                            StarterGui:SetCore("SendNotification", {Title="Teleported", Text="Menuju: "..Target.Name})
                        end
                    end
                end)
            end

            -- Update Stats Panel
            if States.Panel then
                pcall(function()
                    local ls = Player:FindFirstChild("leaderstats")
                    local c = ls and ls:FindFirstChild("Caught")
                    LblFish.Text = c and tostring(c.Value) or "0"
                    
                    local bp = Player:FindFirstChild("Backpack")
                    LblBag.Text = bp and tostring(#bp:GetChildren()) or "0"
                end)
            end
        end
    end)

    -- Noclip Loop
    RunService.Stepped:Connect(function()
        if States.Noclip and Player.Character then
            for _, v in pairs(Player.Character:GetChildren()) do
                if v:IsA("BasePart") and v.CanCollide then v.CanCollide = false end
            end
        end
    end)

    -- Water Walk Height Control
    RunService.Heartbeat:Connect(function()
        if States.WoW and HRP then
            local vel = HRP.AssemblyLinearVelocity
            HRP.AssemblyLinearVelocity = Vector3.new(vel.X, 0, vel.Z)
        end
    end)

    -- Notif Sukses
    StarterGui:SetCore("SendNotification", {Title="Fixed", Text="Seraphin Loaded!", Duration=3})
end

-- Menjalankan dengan aman
local s, e = pcall(SafeLoad)
if not s then warn("Script Error: " .. tostring(e)) end
